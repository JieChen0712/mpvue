<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript">
      var TP_PUBLIC = '__PUBLIC__';
      var agentseeurl = '__APP__/admin/manage/get_not_audit';
      var agentpassurl = '__APP__/admin/manage/audit';
      var getCavConfig = '__APP__/home/manager/get_certificate_config';
      var cavConfig = "";
    </script>
    <script type="text/javascript" src='__PUBLIC__/js/jquery.js'></script>
    <style>
      .certificate p {
        display: none;
      }
      .certificate {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>

  </head>

  <body>
    <div class="card" style="background-color: transparent; overflow: auto;">
      <div class="certificate">
        <canvas id="thecanvas" width="652" height="920" style="width:327px;height:460px;"></canvas>
      </div>
    </div>
    <script type="text/javascript">
      $(function() {
        //加载授权书图片
        loadImg();
      })
      //		绘画证书的canvas
      function draw(img) {
        var canvas = document.getElementById("thecanvas");
        var ctx = canvas.getContext("2d");
        //			context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
        //			context.drawImage(规定要使用的图像、画布或视频,截取图片开始的x轴,截取图片开始的y轴,图片显示内容的宽度,图片显示内容的高度,在canvas上的开始坐标x,在canvas上的开始坐标y,图片缩放 的宽度/决定图片在画布上的宽度,图片缩放的高度/决定图片在画布上的高度);
        //			四个值的时候默认为开始的x,y坐标,图片在画布的大小width,height(默认是整张图片在画布上的缩放)
        ctx.drawImage(img, 0, 0, 652, 920);

        $.each(cavConfig, function(key, value) {
          if(key == "bgImg" || value.open != "1"||value.str==""||value.str==null||value.str==undefined) return;
          ctx.fillStyle = value.fillStyle;
          ctx.font = value.font;
          ctx.fillText(value.str, value.x, value.y);
          ctx.restore();
        });

        canvas.style.display = "none";
        var type = 'png'; //你想要什么图片格式 就选什么吧
        var d = document.getElementById("thecanvas");
        var imgdata = d.toDataURL(type);
        var png = new Image();
        png.src = imgdata;
        $('.warrant img').attr('src', imgdata);
        $(png).attr("id", "imgtrue");
        if(!$(".certificate").children("#imgtrue").length > 0) {
          $(".certificate").append(png);
        }

      }

      //加载授权书图片
      function loadImg() {
        var u_id = '{$manager.id}';

        var userId = null;
        if(u_id != "" && u_id != undefined && u_id != null) {
          userId = u_id;
        }

        $.ajax({
          url: getCavConfig,
          async: false,
          success: function(data) {
            if(data.code == 1) {
              cavConfig = JSON.parse(data.info);
              $.each(cavConfig, function(key, value) {
                if(key == "bgImg") {
                  var str = value.join("");
                  cavConfig[key] = str;
                  return;
                }
                cavConfig[key] = JSON.parse(value);
              });
            } else {
              console.log(data.msg)
            }
          }
        });

        $.post('__APP__/home/manager/get_user_ajax', {
            id: userId
          },
          function(data) {
            if(data.code == 1) {
              $.each(cavConfig, function(key, value) {
                if(key.toString()!="company"){
                    cavConfig[key]["str"] = data.info[key];
                }
              });
              //            cavConfig.dateTime = data.info.start_time_format3;
              var img = new Image();
              img.src = '__ROOT__' + cavConfig.bgImg;
              //      将图片设置为隐藏，并添加到页面上渲染
              $(img).hide()
              $('.certificate').append(img);
              //        在证书背景图完全加载完后才开始绘画证书,和添加点击监听事件
              img.onload = function() {
                draw(img);
              }
            } else {
              console.log(data);
            }
          });
      }

      function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if(r != null) return unescape(r[2]);
        return null;
      }
    </script>
  </body>

</html>