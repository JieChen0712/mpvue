<script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="__PUBLIC__/Admin_v3/css/city-picker.css" />
<script src="__PUBLIC__/Admin_v3/js/light7-city-picker.min.js" type="text/javascript" charset="utf-8"></script>
<div class="city_picker">
    <span class="icon icon-right picker-icon" name="addr"></span>
    <div class="select-wrapper">
        <input type="text" class='city-picker' placeholder="请选择地址" value="[re_province] [re_city] [re_county]">
        <div class="three-select">
            <select name="province" class="province" placeholder="请选择地址">
                <option value="">请选择</option>
            </select>
            <select name="city" class="city">
                <option value="">请选择</option>
            </select>
            <select name="county" class="county">
                <option value="">请选择</option>
            </select>
        </div>
        <input type="hidden" name="probably_address" class="probably_address" value="{$arr}" />
        <p class="change_picker">更换方式</p>
    </div>
</div>

<script type="text/javascript">
    var re_province = "[re_province]";
    var re_city = "[re_city]";
    var re_county = "[re_county]";
    var china = Object;
    var province = new Array(),
        province1, city = new Array(),
        city1, area = new Array();
    
    $.ajax({url:"__PUBLIC__/Radmin_v3/plugs/echart/map/area.json",async:false, success:function(data) {
        province = new Array();
        china = data;
        $.each(china, function(key, value) {
            if(value.name==re_province){
                province.push('<option value="' + value.name + '" selected>' + value.name + '</option>');
            }else{
                province.push('<option value="' + value.name + '">' + value.name + '</option>');
            }
        })
        $('.province').append(province);
        }
    })

    $(document).on('change', '.province', function() {
        var str = $(this).children('option:selected').val()
        getCity(str);
        $('.probably_address').val(getselectStr());
    });

    $(document).on('change', '.city', function() {
        var str = $(this).children('option:selected').val()
        getCounty(str);
        $('.probably_address').val(getselectStr());
    });
    
    $(document).on('change', '.county', function() {
        $('.probably_address').val(getselectStr());
    })
    
    $('.city-picker').hide();
    $('.picker-icon').hide();
    
    $(document).on('click','.change_picker',function(){
        $('.city-picker').toggle();
        $('.picker-icon').toggle();
        $('.three-select').toggleClass('hide');
    });
    
    $(".city-picker").cityPicker({
        toolbarTemplate: '<header class="bar bar-nav"><button class="button button-link pull-left close-picker">取消</button><button class="button button-link pull-right close-picker sure">确定</button><h1 class="title">选择地址</h1></header>'
    });
    $(document).on("click", ".sure", function() {
        $('.probably_address').val($(".city-picker").val());
    })
    $(document).on("change", ".city-picker", function() {
        $('.probably_address').val($(".city-picker").val());
    })
    
//  $(document).on("change", ".city-picker", function() {
//      $('.probably_address').val($(".city-picker").val());
//  })
    
    if(re_province!=""){
        getCity(re_province);
        if(re_city!=""){
            $('.city option[value="'+re_city.substring(0,re_city.length-1)+'"]').attr("selected",true);
            $('.city option[value="'+re_city+'"]').attr("selected",true);
            getCounty(re_city);
            getCounty(re_city.substring(0,re_city.length-1));
            if(re_county!=""){
                $('.county option[value="'+re_county.substring(0,re_county.length-1)+'"]').attr("selected",true);
                $('.county option[value="'+re_county+'"]').attr("selected",true);
            }
        }
    }
    
    function getselectStr(){
        var str = '';
        $.each($('.three-select select'), function(key,value) {
            if($(value).val()!="请选择" && $(value).val()!=null){
                str += $(value).val()+" ";
            }
        });
        return str;
    }
    
    function getCity(str){
        province1 = str;
        city = new Array();
        $.each(china, function(key, value) {
            if(province1 === value.name) {
                $.each(value.sub, function(k, v) {
                    if(v.name==re_city){
                        city.push('<option value="' + v.name + '" selected>' + v.name + '</option>');
                    }else{
                        city.push('<option value="' + v.name + '">' + v.name + '</option>');
                    }
                });
            }
        });
        $('.city').empty().append(city);
        $('.county').empty();
    }
    
    function getCounty(str){
        area = [];
        city1 = str;
        county = new Array();
        $.each(china, function(key, value) {
            if(province1 == value.name) {
                $.each(value.sub, function(k, v) {
                    console.log(city1+' : ' +v.name)
                    if(city1 == v.name||(city1==v.name.substring(0,v.name.length-1))) {
                        if(!(v.sub == undefined || v.sub == "" || v.sub == null)) {
                            $.each(v.sub, function(i, j) {
                                if(j.name==re_county){
                                    area.push('<option value="' + j.name + '" selected>' + j.name + '</option>');
                                }else{
                                    area.push('<option value="' + j.name + '">' + j.name + '</option>');
                                }
                            });
                        }
                    }
                });
            }
        });
        $('.county').empty().append(area);
    }
</script>