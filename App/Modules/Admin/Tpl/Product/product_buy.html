<!DOCTYPE html>
<html>
    <head lang="en">
        <title>立即下单</title>
    <include file="Public/header_v2.1"/>
    <link rel="stylesheet" href="__PUBLIC__/Admin_v2/css/product_buy.css">
    <link rel="stylesheet" href="__PUBLIC__/Admin_v2/css/bootstrap.min.css">
    <script type="text/javascript" src="__PUBLIC__/radmin/js/bootstrap.min.js"></script>
</head>
<body>
    <header class="header">
        <p>立即下单</p>
        <a href="javascript:history.go(-1);" class="a"></a>
    </header>
    <div class="container">
        <!--__URL__/address?return_url={$return_url}-->
        <a href="__URL__/address_choose?return_url={$return_url}">
            <div class="row">
                <input type="hidden" id="rec_id" value="{$receiving_info.id}" />
                <div class="col-xs-8 col-sm-6 col-md-5">收货人：{$receiving_info.name}</div>
                <div class="col-xs-4 col-sm-6 col-md-5">{$receiving_info.phone}</div> 
                <div class="col-xs-11 col-sm-8 col-md-8">{$receiving_info.area}{$receiving_info.addre}</div>
                <div class="col-xs-1 col-sm-1 col-md-1">
                    <img src="__PUBLIC__/Admin_v2/images/icon-go.png" alt="" id="img-go">
                </div>
            </div>
        </a>
        <hr style="border:none;border-top:15px dotted #185598;" /> 

        <foreach name="templet_info" item="vo">
            <div class="row">
                <img src="{$vo.image}" alt="" class="img-thumbnail">
                <div style="float:left;padding-left:15px;">
                    <p>{$vo.name}</p>
                    <!--                <p>颜色分类：红色</p>
                                    <p>尺码：S</p>-->
                    <p style="color:red">￥ {$vo.price}</p>
                    <input type="hidden" id="templet_id{$vo.cal_id}" value="{$vo.id}" />
                    <input type="hidden" id="price{$vo.cal_id}" value="{$vo.price}" />
                    <input type="hidden" id="sku_id{$vo.cal_id}" value="{$vo.sku_id}" />
                </div>

            </div><hr color=#d0d0d0>

            <div class="row">
                <span>购买数量</apan>
                    <div style="float:right">   
                        <input id="min" onclick="return jian('{$vo.cal_id}')" name="" type="button" value=" ─ " />

                        <input onchange="return conutmoney();" id="buynum{$vo.cal_id}" type="text" value="{$vo.buy_num}" style="width:150px;text-align:center;"  />
                        <input id="add" onclick="return jia('{$vo.cal_id}')" name="" type="button" value=" ✛ " />
                    </div>
            </div><hr color=#d0d0d0>
        </foreach>


        <div class="row">
            <strong>备注</strong><hr color=#d0d0d0>
            <p>
                <textarea class="textarea" placeholder="输入备注信息..." name="remark" id=""></textarea>
            </p>
        </div>

    </div>  
    
    <div style="height: 100px;"></div>
    
    <div class="footer">
        <span style="color:red;" id="count">合计:￥<span id="conutmoney"></span></span>
        <a href="#"><button type="button" onclick="return orderhand();" class="btn btn-warning" id="new">提交订单</button></a>
    </div> 


<!--    <div class="modal fade bs-example-modal-lg choose_address" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
      <div class="modal-dialog modal-lg" role="document">
          
        <div class="modal-content">
            <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="gridSystemModalLabel">Modal title</h4>
          </div>
            <div class="modal-body">
                <foreach name="list" item="vo">
           
                </foreach>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
            
          
        </div>
      </div>
    </div>-->
    
    

</body>
<script>
    $(document).ready(function (e) {
        conutmoney();
    });
    
//    function jia(id) {
//        var qty = Number($('#buynum'+id).val());
//        $('#buynum'+id).val(qty + 1);
//        
//        conutmoney();
//    }
//    function jian(id) {
//        var qty = Number($('#buynum'+id).val());
//        if (qty <= 1) {
//            tusi("商品数量不能小于1");
//            return;
//        }
//        $('#buynum'+id).val(qty - 1);
//        
//        conutmoney();
//    }
    
    function conutmoney(){
        var j = '{$templet_count}';
        
        var conutmoney = 0;
        for (var i = 1; i <= j; i++) {
            var pro_id = $('#templet_id' + i).val();
            var pro_num = $('#buynum' + i).val();
            var price = $("#price"+i).val();
            
            
            if( price != 0 && price != '' && price != null && pro_num != 0 && pro_num != '' && pro_num != null ){
                var the_conutmoney = Number(pro_num)*Number(price);
            
                var conutmoney = Number(conutmoney) + Number(the_conutmoney);
            }
        }
        
        
        $("#conutmoney").html(conutmoney);
    }
    

    function orderhand() {
        
        if( !confirm('请再次确认您的下单信息！') ){
            return false;
        }
        
        var order_num = new Date().getTime();
        var pd = 0;
        var znumber = 0;
        //tusi(time);
        var j = '{$templet_count}';
        j = Number(j);
        var user_name = $('.p_name').html();
        var phone = $('.p_phone').html();
        var addre = $('.p_addre').html();
        var textarea = $(".textarea").val();
        
        var rec_id = $('#rec_id').val();
        
        var cart_id = '{$cart_id}';

//        if (phone == "") {
//            tusi('请输入手机号码');
//            return false;
//        }
//        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
//        if (!reg.test(phone)) {
//            tusi('请输入正确的手机号码');
//            return false;
//        }

        if( rec_id == '' ){
            tusi('请必须填写收货信息！');
            return false;
        }

        var p_ids = new Array();
        var p_nums = new Array();
        var sku_ids = new Array();

//        var _list_p_nums = {};
//        var _list_p_ids = {};
        for (var i = 1; i <= j; i++) {
            var pro_id = $('#templet_id' + i).val();
            var pro_num = $('#buynum' + i).val();
            
            var sku_id = $('#sku_id' + i).val();
            sku_ids[i] = sku_id;
            
            p_ids[i] = pro_id;
            p_nums[i] = pro_num;
            
        }
        $.post("__APP__/Admin/Order/ordersubmit", {"sku_ids":sku_ids, "p_ids": p_ids, "p_nums": p_nums, order_num: order_num, textarea: textarea,rec_id:rec_id,cart_id:cart_id}, function (data) {
            if (data.code == 1) {
                alert("购买成功！");
                window.location.href="__APP__/Admin/index"; 
            } else {
                var msg = '下单失败！';
                if (data.msg != null) {
                    msg = data.msg;
                }
                tusi(msg);
            }
        });

    }
    
    //选择地址
    function choose_address(){
        
        
        $('.choose_address').modal('show');
    }//end func choose_address
    
    
    
</script>
</html>