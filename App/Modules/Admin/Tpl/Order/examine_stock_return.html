<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
        <title>处理下级订单</title>
        <include file="Public/header_v3" />
        <link rel="stylesheet" href="__PUBLIC__/Admin_v3/css/order-detail.css" type="text/css" />

    </head>

    <body>
        <div class="page" style="background:#F5F4F9;">
            <!-- header start-->
            <!--	        <header id="header" class="bar bar-nav">
	            <button class="back button button-link button-nav pull-left">
	                <a href="javascript:history.go(-1);" > <span class="icon icon-left">返回</span></a>
	            </button>
	            <button class="more button button-link button-nav pull-right">
	                <img class="img" src="__PUBLIC__/Admin_v3/images/clock.jpg" height="26">
	                <span class="text">10</span>
	                <i class="circle">●●●</i>
	            </button>
	            <h1 class="title">订单明细</h1>
	        </header>-->
            <div class="buttons-tab">
                <a href="#tab2" class="tab-link active button btns color-examine-nav" data-stat='0' data-page="1">未审核</a>
                <a href="#tab3" class="tab-link button btns color-examine-nav" data-stat='1' data-page="1">已审核</a>
                <a href="#tab4" class="tab-link button btns color-examine-nav" data-stat='2' data-page="1">不通过</a>
            </div>
            <div class="order-detail">
                <div class="content infinite-scroll">
                    <div class="content-block wrappers">
                        <div class="tabs">

                            <div id="tab2" class="tab active">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab3" class="tab">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab4" class="tab">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--script start-->
        <script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>
        <script>
            //初始化变量
            var imgSrc = '__PUBLIC__/Admin_v3/images/empty.png';
            var allurl = '__GROUP__/order/get_stock_return_apply';
            var errorno = 1;
            var loading = false;
            var target = $(".buttons-tab").children(".active");
            // 取消订单
            $(function() {
                $(document).on('click', '.cancel-order', function() {
                    var apply_id = $(this).data('id');
                    $.confirm('是否取消退货申请？', function() {
                        $.post('cancel_stock_apply', {
                            apply_id: apply_id
                        }, function(res) {
                            tusi(res.msg);
                            setTimeout(function() {
                                window.location.href = changeURLArg(window.location.href, "reloadtime", new Date().valueOf());
                            }, 1000);
                        });
                    })
                });
            });
            // 审核订单
            //			$(function() {
            //				$(document).on("click", '.firm_order', function() {
            //					var order_num = $(this).data('id');
            //					console.log(order_num);
            //					$.post('firm_order', {
            //						order_num: order_num
            //					}, function(res) {
            //						if(res) {
            //							tusi('审核成功');
            //							setTimeout(function(){window.location.href = changeURLArg(window.location.href, "reloadtime", new Date().valueOf());},1000);
            //						} else {
            //							tusi('审核失败');
            //						}
            //					});
            //				})
            //			});
            //          查看订单
            //			$(function() {
            //				$(document).on("click", '.all-list', function() {
            //					var order_num = $(this).data('id');
            //					console.log(order_num);
            //					$.post('order_num', {
            //						order_num: order_num
            //					}, function(res) {
            //						if(res) {
            //							window.location.href = 'shipping_order_detail?order_number=' + order_num;
            //						}
            //					});
            //				})
            //			});
            //    查看订单
            //    $(function() {
            //				$(document).on("click", '.order_detail', function() {
            //					var order_num = $(this).data('id');
            //					console.log(order_num);
            //					$.post('order_num', {
            //						order_num: order_num
            //					}, function(res) {
            //						if(res) {
            //							window.location.href = 'shipping_order_detail?order_number=' + order_num;
            //						}
            //					});
            //				})
            //			});
            $().ready(function() {

                //			    $(document).on("click", '.all-list,.order_detail', function() {
                //                  var return_id = $(this).data('id');
                //                  window.location.href = 'stock_return_detail?id=' + return_id;
                //              })

                //获取信息的方法
                addItems(target)
                //加载的方法
                function addItems(aim) {
                    var html = [];
                    var count = 0;
                    var page = Number($(aim).attr('data-page'));
                    var stat = $(aim).attr('data-stat');

                    $.post(allurl, {
                            status: stat,
                            page_num: page,
                            status: stat
                        },
                        function(data) {
                            console.log(data)
                            if(data.code == 1) {
                                $(aim).attr('data-page', (page + 1));
                                aim = $($(aim).attr('href'));
                                var str = '';
                                if(data.info.list == null || data.info.list == undefined || data.info.list == "") {
                                    // str = '<dl class="not-string"><p style="text-align:center">暂无更多数据！</p></dl>';
                                    $.detachInfiniteScroll($('.infinite-scroll'));
                                    aim.find(".infinite-scroll-preloader").remove();
                                    // if(aim.children("dl").hasClass("no-data")) {
                                    // 	return;
                                    // }
                                    // aim.append(str);
                                    if($(aim).find('dl').length == 0) {
                                        if(!$(aim).find('.emptyImg').length > 0) {
                                            var oImg = '<div class="emptyImg" style="margin-top: 150px;overflow:hidden; text-align: center; background:#F5F4F9;"><img src=' + imgSrc + ' style="width: 200px;"><div>'
                                            aim.append(oImg);
                                        }
                                    }
                                    if($(aim).find('dl').length > 2) {
                                        tusi('暂无更多数据！');
                                    }

                                    loadings = false;
                                    aim.attr("data-flag", "true");
                                    return;
                                }

                                // 整体html
                                var html = '';
                                var all = [];

                                //获取对应的按钮
                                var btnHtml = '';
                                // 只需获取一次
                                var userImg = '';
                                var userName = '';
                                var orderStatus = '';
                                var total_num = '';
                                var goodsImg = '';
                                var product_name = '';
                                var time = '';

                                $.each(data.info.list, function(key, value) {
                                    var temp = [];
                                    count++;
                                    userName = value.dis_info.name;
                                    userImg = value.dis_info.headimgurl;
                                    if(value.status == "0") {
                                        orderStatus = "未审核";
                                    } else if(value.status == "1") {
                                        orderStatus = "已审核";
                                    } else {
                                        orderStatus = "不通过";
                                    }

                                    total_num = value.num;
                                    goodsImg = '__ROOT__' + value.temp_info.image;
                                    product_name = value.temp_info.name;
                                    time_str = value.updated_foramt;

                                    if(value.status == 0) {
                                        btnHtml = '<div class="order-btn"><input type="button" value="取消申请" data-id="' + value.id + '" class="button button-dark cancel-order">' +
                                            '</div></dl>';
                                    }
                                    //                                      else if(value.status == 1||value.status == 2) {
                                    //											btnHtml = '<div class="order-btn"><input type="button" value="查看详情" data-id="' + value.id + '" class="button button-dark order_detail" /></div></dl>';
                                    //										}

                                    html = '<dl class="all-detail"><dt><img src="' + userImg + '"><span>' + userName + '</span><p class="color-examine-status">' + orderStatus + '</p></dt><dd>';

                                    var str = '<div class="all-list" data-id="' + value.id + '"><img src="' + goodsImg + '" alt=""><div class="goods-detail"><div class="details-top"><p>' + product_name + '</p>' +
                                        '<p></p></div><div class="details-bottom">';
                                    //                                      if (value[i].style) {
                                    //                                          str += '<p>规格：'+value[i].style+'</p>';
                                    //                                      } else {
                                    //                                          str +='<p></p>';
                                    //                                      }
                                    str += '<p>x' + total_num + '</p></div></div></div>';

                                    //  					var str1='<div class="all-list" data-id="'+orderNum+'">'
                                    var str2 = '<p class="goods-sum"><span>共' + total_num + '件商品</span></p></dd>';

                                    html += str + str2 + btnHtml;
                                    //									html += str + str2;
                                    all.push(html)
                                    //  					console.log(all)
                                });
                                aim.prepend(all);

                                if(count < 3) {
                                    // str = '<dl class="not-string"><p style="text-align:center">暂无更多数据！</p></dl>';
                                    $.detachInfiniteScroll($('.infinite-scroll'));
                                    aim.find(".infinite-scroll-preloader").remove();
                                    loadings = false;
                                    aim.attr("data-flag", "true");
                                    // if(!aim.children("dl").hasClass("no-data")) {
                                    //     // aim.append(str);
                                    //     // tusi('暂无更多数据！');

                                    //     return;
                                    // }

                                    // return;
                                }

                            } else {
                                console.log(data)
                                $.alert(data.msg)
                            }
                        });
                }

                $.attachInfiniteScroll($('.infinite-scroll'));

                //监听滚动事件
                $(document).on('infinite', '.infinite-scroll', function() {
                    target = $(".buttons-tab").children(".active");
                    // 如果正在加载，则退出
                    if(loading) return;
                    // 设置flag
                    loading = true;

                    setTimeout(function() {
                        loading = false;
                        //记录状态
                        var temp_target = $(target).attr('href');
                        if($(temp_target).attr("data-flag") == "true") {
                            return;
                        } else {
                            addItems(target)
                        }
                    }, 1000);
                });
                //切换tab时初始化
                $(".buttons-tab .tab-link").bind("click", function() {
                    stat = $(this).data("stat");
                    $.attachInfiniteScroll($('.infinite-scroll'));
                    target = this;
                    var temp_target = $(target).attr('href');
                    if(loadings) {
                        return;
                    }
                    if($(temp_target).attr("data-flag") == "true") {
                        return;
                    } else {
                        addItems(target)
                        loadings = false;
                    }
                });
            });
            //设置url参
            function changeURLArg(url, arg, arg_val) {
                var pattern = arg + '=([^&]*)';
                var replaceText = arg + '=' + arg_val;
                if(url.match(pattern)) {
                    var tmp = '/(' + arg + '=)([^&]*)/gi';
                    tmp = url.replace(eval(tmp), replaceText);
                    return tmp;
                } else {
                    if(url.match('[\?]')) {
                        return url + '&' + replaceText;
                    } else {
                        return url + '?' + replaceText;
                    }
                }
                return url + '\n' + arg + '\n' + arg_val;
            }
        </script>
        <!--script end-->
    </body>

</html>