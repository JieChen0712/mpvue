<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
        <title>提交订单</title>

        <include file="Public/header_v3" />

        <link rel="stylesheet" type="text/css" href="__PUBLIC__/Admin_v3/css/order-list.css" />
    </head>
    <script>
        var uploadUrl = '__APP__/Home/Manager/uploadCanvas';
    </script>

    <body>
        <div class="page">
            <!-- header start-->
            <include file="Public/header_features_v3" />
            <!-- header end-->
            <div class="content content-order">
                <section class="order-address">
                        <div id="add_address" class="address-link external">
                            <ul>
                                <li>收货人:<span id="s_name">{$share_info.s_name}</span></li>
                                <i class="icon icon-right"></i>
                                <li>手机号:<span id="s_phone">{$share_info.s_phone}</span></li>
                                <li>地&nbsp;&nbsp;址: <span id="address">{$share_info.s_addre}</span>
                                    <input type="hidden" name="province" id="province" value="{$share_info.province}" />
                                    <input type="hidden" name="city" id="city" value="{$share_info.city}" />
                                    <input type="hidden" name="county" id="county" value="{$share_info.county}" />
                                </li>
                            </ul>
                        </div>
                </section>
                <section class="order-alist">
                    <ul>
                        <li>
                            <!--<p class="seller-inf"><img src="{$manager.headimgurl}" alt="" />{$manager.name}</p>-->
                            <div class="goods-infs">
                                <img src="__ROOT__{$product.image}" />
                                <p class="goods-title">{$product.name}
                                    <span class="goods-format" style="display: inline;float: right;">x{$num}</span>
                                </p>
                                <notempty name="properties">
                                    <p class="goods-format">规格：{$properties}</p>
                                </notempty>
                                <notempty name="reduce_info">
                                    <p class="goods-format">
                                        <eq name="reduce_info.price_way" value="2">参数：{$product.product_parameter}kg</eq>
                                        <eq name="reduce_info.price_way" value="3">参数：{$product.product_parameter}m³</eq>
                                    </p>
                                </notempty>

                                <p class="goods-price">￥<span class="priceval">{$product.price}</span></p>
                                <!--<p class="goods-title" style="margin-top: 0px;"><span class="priceval" style="color: #787878;margin-left: 1px;">x{$num}</span> </p>-->
                            </div>
                            <!--<div class="count-num">
                    <span>购买数量</span>
                    <input type="number" name="shownum" class="shownum" value="{$num}" readonly="readonly" />
                    <input type="hidden" name="product_id" value="{$product.id}"/>
                </div>-->
                        </li>
                    </ul>
                    <input type="hidden" name="shownum" class="shownum" value="{$num}" readonly="readonly" />
                    <input type="hidden" name="product_id" value="{$product.id}" />
                    <input type="hidden" name="sku_ids" value="{$sku_id}" />
                </section>
                <!--运费相关-->
                
                <!--end运费相关-->
                <div class="remark">
                    备注信息：
                    <textarea name="note" rows="3" placeholder="请输入备注" maxlength="50"></textarea>
                </div>

                <div class="pay-way">
                    <div>
                        支付截图:
                        <!--<label>
                                    <input type="radio" name="payWay" data-name="1" value="1">虚拟币
                                </label>
                        <label>
                                    <input type="radio" name="payWay" checked data-name="2" value="2">支付截图
                                </label>-->
                    </div>

                    <div class="upLoadImg-wrapper">
                        <include file="Public/upLoadImg" />
                    </div>
                </div>

            </div>
            <div id="mask">
                <div class="address_info">
                    <h1 class="titles">填写地址</h1>
                    <div class="info_item">
                        <label class="text">收货人：</label>
                        <input type="text" name="re_name" id="re_name" value="{$share_info.s_name}"/>
                    </div>
                    <div class="info_item">
                        <label class="text">手机号：</label>
                        <input type="phone" name="re_phone" id="re_phone" value="{$share_info.s_phone}"/>
                    </div>
                    <div class="info_item">
                        <label class="text">地址：</label>
                        <input type="text" id='city-picker' name="re_address" value="{$share_info.province} {$share_info.city} {$share_info.county}"/>
                    </div>
                    <div class="info_item">
                        <textarea name="address_detail" id="address_detail" rows="2" cols="50" placeholder="请填写详细地址">{$addre_detail}</textarea>
                    </div>
                    <button class="button button-fill button-success" id="btn_sure">确定</button>
                </div>
            </div>
            <footer class="submit-order">
                <p>合计：￥
                    <span id="countprice">{$total_money}</span>
                    <span style="display: block;" id="shipper_fee">(运费:￥{$total_money_fee})</span>
                </p>
                <input type="hidden" id="shipping-way"/>
                <input type="hidden" id="shipping-id" name="shipping_way_id"/>
                <input type="button" name="submit-order" id="submit-order" value="提交订单" />
            </footer>
        </div>
        <script src="__PUBLIC__/Admin_v3/js/jquery.js" type="text/javascript" charset="utf-8"></script>
        <script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="__PUBLIC__/Admin_v3/js/order-list-shop.js" type="text/javascript" charset="utf-8"></script>
        <script src="__PUBLIC__/Admin_v3/js/light7-city-picker.min.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript">
            var shipping_open = <?php echo C('ORDER_SHIPPING');?>;
            var total_money = Number({$total_money});
            var now_url = '__URL__/';
            var wayId;
            var p_id = getUrlParam('id')
            var selectArr = [];
            var get_shipping = '__GROUP__/order/get_shipping_ajax';
            var province = $('#province').text();
            var shipping_way;
            var tempData;
            setShipper();
//          $.ajax({
//              type: 'POST',
//              url: get_shipping,
//              data: {
//                  id: p_id
//              },
//              async: false,
//              success: function(data) {
//                  if(data.code == 1) {
//                      var temp = [];
//                      tempData = data;
//
//                      $.each(data.info, function(key, value) {
//                          if(value.shipping_way == 0 && $.inArray("快递", temp) == -1) {
//                              temp.push('快递')
//                              if($('#shipping-way').val() == "") {
//                                  $('#shipping-way').val(0)
//                                  shipping_way = 0;
//                              }
//                          } else if(value.shipping_way == 1 && $.inArray("EMS", temp) == -1) {
//                              temp.push('EMS')
//                              if($('#shipping-way').val() == "") {
//                                  $('#shipping-way').val(1)
//                                  shipping_way = 1;
//                              }
//                          } else if(value.shipping_way == 2 && $.inArray("邮政", temp) == -1) {
//                              temp.push('邮政')
//                              if($('#shipping-way').val() == "") {
//                                  $('#shipping-way').val(2)
//                                  shipping_way = 2;
//                              }
//                          }
//                      });
//                      //                switch (temp.length) {
//                      //                    case 1:
//                      //                        shipping_way = 2;
//                      //                        break;
//                      //                    case 2:
//                      //                        shipping_way = 1;
//                      //                        break;
//                      //                    case 3:
//                      //                        shipping_way = 0;
//                      //                        break;
//                      //                    default:
//                      //                        break;
//                      //                }
//                      //                console.log(123)
//                      $.each(data.info, function(key, value) {
//                          console.log(value.area_name.indexOf(province))
//                          if(value.area_name.indexOf(province) >= 0 && value.shipping_way == shipping_way) {
//                              $('#shipping-id').val(value.id)
//                          } else if(value.shipping_way == shipping_way && $('#shipping-id').val() == "") {
//                              $('#shipping-id').val(value.id)
//                          }
//                      });
//                      selectArr = temp;
//                      $('#picker-way').val(selectArr[0]);
//                  } else {
//                      alert(data.msg)
//                  }
//              }
//          })
            $(function() {
                $('#btn_sure').bind('click', function() {
                    $('#mask').fadeOut();
//                  setCookie('citypicker',$('#city-picker').val(),3);
//                  setCookie('re_detail',$('#address_detail').val(),3);
//                  setCookie('re_phone',$('#re_phone').val(),3);
//                  setCookie('re_name',$('#re_name').val(),3);
                    $('#s_name').text($('#re_name').val());
                    $('#s_phone').text($('#re_phone').val());
                    var address = ($('#city-picker').val()).trim().split(' ');
                    console.log(address)
                    $('#province').val(address[0]);
                    $('#city').val(address[1]);
                    $('#county').val(address[2]);
//                  $('#s_name').text($('#city-picker').val());
                    $('#address').text(($('#city-picker').val()).trim() + ' ' + $('#address_detail').val());
                    setShipper();
                });
                
                $("#city-picker").cityPicker({
                    toolbarTemplate: '<header class="bar bar-nav"><button class="button button-link pull-right close-picker">确定</button><h1 class="title">添加地址</h1></header>'
                });
                $('#add_address').bind('click', function() {
                    $('#mask').fadeIn();
                });
//              $(document).on('click', '.choose-way', function() {
//                  var str = $('#picker-way').val();
//                  switch(str) {
//                      case '快递':
//                          wayId = 0;
//                          break;
//                      case 'EMS':
//                          wayId = 1;
//                          break;
//                      case '邮政':
//                          wayId = 2;
//                          break;
//                      default:
//                          wayId = 0;
//                          break;
//                  }
//                  $('#shipping-way').val(wayId);
//                  shipping_way = wayId;
//                  $('#shipping-id').val("");
//                  $.each(tempData.info, function(key, value) {
//                      if(value.area_name.indexOf(province) >= 0 && value.shipping_way == shipping_way) {
//                          $('#shipping-id').val(value.id)
//                      } else if(value.shipping_way == shipping_way && $('#shipping-id').val() == "") {
//                          $('#shipping-id').val(value.id)
//                      }
//                  });
//                  //计算运费
//                  //        $.post("__GROUP__/order/get_shipping_fee",{id:p_id,shipping_way:$('#shipping-way').val(),shipping_id:$('#shipping-id').val(),num:getUrlParam('num')},function(data){
//                  //          if(data.code == 1){
//                  //            $('#countprice').text(data.info.toatl_money+'(含运费:￥'+ data.info.toatl_money_fee +')');
//                  //          }else{
//                  //            console.log(data.msg);
//                  //          }
//                  //        });
//
//                  getShippingWay()
//              })
            })

            function getShippingWay() {
                $.post("__GROUP__/order/get_shipping_fee", {
                    id: p_id,
                    shipping_way: $('#shipping-way').val(),
                    shipping_id: $('#shipping-id').val(),
                    num: getUrlParam('num')
                }, function(data) {
                    if(data.code == 1) {
                        $('.submit-order').prepend('<p>合计：￥<span id="countprice">'+data.info.toatl_money+'</span><span style="display: block;">(运费:￥'+ data.info.toatl_money_fee+')</span></p>');
//                      $('#countprice').text(data.info.toatl_money + '(含运费:￥' + data.info.toatl_money_fee + ')');
                    } else {
                        console.log(data.msg);
                    }
                });
            }

            //取参
            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
                var r = window.location.search.substr(1).match(reg); //匹配目标参数
                if(r != null) return unescape(r[2]);
                return null; //返回参数值
            }

            $('document').ready(function() {
//              getShippingWay()
                $("input[name='payWay']").click(function() {
                    if($(this).val() == 2) {
                        $('.upLoadImg-wrapper').fadeIn();
                    } else {
                        $('.upLoadImg-wrapper').fadeOut();
                    }
                })
            })
            
            function setShipper(){
                var province = $('#province').val();
                $.ajax({
                    type: 'POST',
                    url: get_shipping,
                    data: {
                        id: p_id
                    },
                    async: false,
                    success: function(data) {
                        if(data.code == 1) {
                            var temp = [];
                            tempData = data;
    
                            $.each(data.info, function(key, value) {
                                if(value.shipping_way == 0 && $.inArray("快递", temp) == -1) {
                                    temp.push('快递')
                                    if($('#shipping-way').val() == "") {
                                        $('#shipping-way').val(0)
                                        shipping_way = 0;
                                    }
                                } else if(value.shipping_way == 1 && $.inArray("EMS", temp) == -1) {
                                    temp.push('EMS')
                                    if($('#shipping-way').val() == "") {
                                        $('#shipping-way').val(1)
                                        shipping_way = 1;
                                    }
                                } else if(value.shipping_way == 2 && $.inArray("邮政", temp) == -1) {
                                    temp.push('邮政')
                                    if($('#shipping-way').val() == "") {
                                        $('#shipping-way').val(2)
                                        shipping_way = 2;
                                    }
                                }
                            });
                            //                switch (temp.length) {
                            //                    case 1:
                            //                        shipping_way = 2;
                            //                        break;
                            //                    case 2:
                            //                        shipping_way = 1;
                            //                        break;
                            //                    case 3:
                            //                        shipping_way = 0;
                            //                        break;
                            //                    default:
                            //                        break;
                            //                }
                            //                console.log(123)
                            $.each(data.info, function(key, value) {
                                console.log(value.area_name.indexOf(province))
                                
                                if(value.area_name.indexOf(province) >= 0 && value.shipping_way == shipping_way) {
                                    var total_shipper_fee = 0;
                                    $('#shipping-id').val(value.id);
                                    if(getUrlParam('num')<=value.first_num){
                                        total_shipper_fee = Number(value.first_fee).toFixed(2);
                                        $('#shipper_fee').text('(运费:￥'+ total_shipper_fee+')');
                                    }else{
                                        var overflow = parseInt(getUrlParam('num')) - Number(value.first_num);
                                        total_shipper_fee = Number(value.first_fee) + (overflow/Number(continue_num) *Number(continue_fee));
                                        $('#shipper_fee').text('(运费:￥'+ total_shipper_fee.toFixed(2)+')');
                                    }
                                    $('#countprice').text((Number(total_shipper_fee)+Number(total_money)).toFixed(2))
                                } else if(value.shipping_way == shipping_way && $('#shipping-id').val() == "") {
                                    var total_shipper_fee = 0;
                                    $('#shipping-id').val(value.id);
                                    if(getUrlParam('num')<=value.first_num){
                                        total_shipper_fee = Number(value.first_fee).toFixed(2);
                                        $('#shipper_fee').text('(运费:￥'+ total_shipper_fee+')');
                                    }else{
                                        var overflow = parseInt(getUrlParam('num')) - Number(value.first_num);
                                        total_shipper_fee = Number(value.first_fee) + (overflow/Number(continue_num) *Number(continue_fee));
                                        $('#shipper_fee').text('(运费:￥'+ total_shipper_fee.toFixed(2)+')');
                                    }
                                    $('#countprice').text((Number(total_shipper_fee)+Number(total_money)).toFixed(2))
                                }
                                
                            });
                            selectArr = temp;
                            $('#picker-way').val(selectArr[0]);
                        } else {
                            alert(data.msg)
                        }
                    }
                })
            }
        </script>
        <!--script strat-->
        

        <!--script end-->
    </body>

</html>