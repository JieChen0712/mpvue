<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
        <title>处理下级订单</title>
        <include file="Public/header_v3" />
        <link rel="stylesheet" href="__PUBLIC__/Admin_v3/css/order-detail.css" type="text/css" />

    </head>

    <body>
        <div class="page" style="background:#F5F4F9;">
            <!-- header start-->
            <!--            <header id="header" class="bar bar-nav">
                <button class="back button button-link button-nav pull-left">
                    <a href="javascript:history.go(-1);" > <span class="icon icon-left">返回</span></a>
                </button>
                <button class="more button button-link button-nav pull-right">
                    <img class="img" src="__PUBLIC__/Admin_v3/images/clock.jpg" height="26">
                    <span class="text">10</span>
                    <i class="circle">●●●</i>
                </button>
                <h1 class="title">订单明细</h1>
            </header>-->
            <div class="buttons-tab">
                <a href="#tab2" class="tab-link active button btns color-examine-nav" data-stat='1'>待审核</a>
                <a href="#tab3" class="tab-link button btns color-examine-nav" data-stat='2'>已发货</a>
                <a href="#tab4" class="tab-link button btns color-examine-nav" data-stat='3'>已收货</a>
            </div>
            <div class="order-detail">
                <div class="content infinite-scroll">
                    <div class="content-block wrappers">
                        <div class="tabs">

                            <div id="tab2" class="tab active">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab3" class="tab">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab4" class="tab">
                                <div class="content-block wrappers" data-flag="false">
                                    <!-- preloader -->
                                    <div class="infinite-scroll-preloader">
                                        <div class="preloader"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--script start-->
        <script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>
        <script>
            //初始化变量
            var imgSrc = '__PUBLIC__/Admin_v3/images/empty.png';
            //          var type_order = GetQueryString("type");
            var type_order = 'shop';
            var auto_order_open = '{$auto_order_open}'
            var allurl = '__GROUP__/order/get_all';
            var errorno = 1;
            var loading = false;
            var page1 = 1;
            var page2 = 1;
            var page3 = 1;
            var stat = '1'; //1：代审核 2：已发货  3：已收货
            var loadings = false;
            var target = $("#tab2").children(".content-block");
            $(function() {
                $(document).on('click', '.cancel-order', function() {
                    var order_num = $(this).data('id');
                    $.confirm('是否取消订单？', function() {
                        console.log(order_num);
                        $.post('cancel_order_oid', {
                            order_num: order_num,
                            type_order: type_order
                        }, function(res) {
                            console.log(res);
                            if(res) {
                                tusi('取消订单成功');
                                setTimeout(function() {
                                    window.location.href = changeURLArg(window.location.href, "reloadtime", new Date().valueOf());
                                }, 1000);
                            } else {
                                tusi('取消订单失败');
                            }
                        });
                    })
                });
            });

            $(function() {
                $(document).on("click", '.firm_order', function() {
                    var order_num = $(this).data('id');
                    console.log(order_num);
                    $.post('firm_order', {
                        order_num: order_num,
                        type: type_order
                    }, function(res) {
                        if(res) {
                            tusi('审核成功');
                            setTimeout(function() {
                                window.location.href = changeURLArg(window.location.href, "reloadtime", new Date().valueOf());
                            }, 1000);
                        } else {
                            tusi('审核失败');
                        }
                    });
                })
            });

            $(function() {
                $(document).on("click", '.all-list', function() {
                    var order_num = $(this).data('id');
                    console.log(order_num);
                    $.post('order_num', {
                        order_num: order_num
                    }, function(res) {
                        if(res) {
                            window.location.href = 'shipping_order_detail?order_number=' + order_num + '&type=' + type_order;
                        }
                    });
                })
            });

            $(function() {
                $(document).on("click", '.order_detail', function() {
                    var order_num = $(this).data('id');
                    console.log(order_num);
                    $.post('order_num', {
                        order_num: order_num
                    }, function(res) {
                        if(res) {
                            window.location.href = 'shipping_order_detail?order_number=' + order_num + '&type=' + type_order;
                        }
                    });
                })
            });
            $().ready(function() {
                //获取信息的方法
                addItems(target)
                //加载的方法
                function addItems(aim) {
                    var html = [];
                    //                  var types = GetQueryString('type')||'shipping';
                    var count = 0;
                    var page = '';

                    if(stat == 1) {
                        page = page1;
                        page1 = page1 + 1;
                    } else if(stat == 2) {
                        page = page2;
                        page2 = page2 + 1;
                    } else if(stat == 3) {
                        page = page3;
                        page3 = page3 + 1;
                    }

                    $.post(allurl, {
                            status: stat,
                            type: type_order,
                            page_num: page
                        },
                        function(data) {
                            console.log(data)
                            if(data.code == 1) {
                                var str = '';
                                if(data.info.list == null || data.info.list == undefined || data.info.list == "") {
                                    // str = '<dl class="not-string"><p style="text-align:center">暂无更多数据！</p></dl>';
                                    $.detachInfiniteScroll($('.infinite-scroll'));
                                    aim.find(".infinite-scroll-preloader").remove();
                                    // if(aim.children("dl").hasClass("no-data")) {
                                    //  return;
                                    // }
                                    // aim.append(str);
                                    if($(aim).find('dl').length == 0) {
                                        if(!$(aim).find('.emptyImg').length > 0) {
                                            var oImg = '<div class="emptyImg" style="margin-top: 150px;overflow:hidden; text-align: center; background:#F5F4F9;"><img src=' + imgSrc + ' style="width: 200px;"><div>'
                                            aim.append(oImg);
                                        }
                                    }
                                    if($(aim).find('dl').length > 2) {
                                        tusi('暂无更多数据！');
                                    }

                                    loadings = false;
                                    aim.attr("data-flag", "true");
                                    return;
                                }

                                // 整体html
                                var html = '';
                                var all = [];

                                //获取对应的按钮
                                var btnHtml = '';
                                // 只需获取一次
                                var userImg = '';
                                var userName = '';
                                var orderStatus = '';
                                var total_num = '';
                                var total_price = '';
                                var orderNum = '';

                                $.each(data.info.list, function(key, value) {
                                    orderNum = key;
                                    var temp = [];

                                    count++;
                                    for(var i = 0; i < value.length; i++) {
                                        //                          console.log(value[i].templet.image)// 商品图片
                                        //                          console.log(value[i].s_name)    // 名字
                                        //                          console.log(value[i].status_name)   //  状态名
                                        //                          console.log(value[i].price) //  价格
                                        //                          console.log(value[i].num)   //  数量
                                        //                          console.log(value[i].templet.name)  //  商品名称
                                        //                          console.log(value[i].total_price)   //  总价格
                                        //                          console.log(value[i].total_num) //  总数量
                                        userName = value[i].u_name;
                                        userImg = value[i].headimgurl;
                                        goodsImg = "";
                                        if(value[i].templet != null) {
                                            goodsImg = '__ROOT__' + value[i].templet.image;
                                        }
                                        userName = value[i].u_name;
                                        orderStatus = value[i].status_name;
                                        total_num = value[i].total_num;
                                        total_price = value[i].total_price;
                                        sum_price = value[i].sum_price;

                                        if(value[i].status == 1) {
                                            btnHtml = '<div class="order-btn"><input type="button" value="取消订单" data-id="' + key + '" class="button button-dark cancel-order">' +
                                                '<input type="button" value="通过审核" data-id="' + key + '" class="button button-danger firm_order" /></div></dl>';
                                        } else if(value[i].status == 2) {
                                            //                                          console.log(value[i].auto_order);
                                            if(type_order == "shop" && auto_order_open && value[i].auto_order == 1 && !(value[i].bind_pid == 0 || value[i].bind_pid == "" || value[i].bind_pid == null)) {
                                                btnHtml = '<div class="order-btn"><input type="button" value="自动下单" data-order="' + key + '" data-bind="' + value[i].bind_pid + '" data-num="' + value[i].total_num + '" class="button button-dark order_auto" /><input type="button" value="查看详情" data-id="' + key + '" class="button button-dark order_detail" /></div></dl>';
                                            } else if(value[i].auto_order == 1 && auto_order_open) {
                                                btnHtml = '<div class="order-btn"><input type="button" value="自动下单" data-order="' + key + '" data-bind="' + value[i].p_id + '" data-num="' + value[i].total_num + '" class="button button-dark order_auto2" /><input type="button" value="查看详情" data-id="' + key + '" class="button button-dark order_detail" /></div></dl>';
                                            } else {
                                                btnHtml = '<div class="order-btn"><input type="button" value="查看详情" data-id="' + key + '" class="button button-dark order_detail" /></div></dl>';
                                            }
                                        } else if(value[i].status == 3) {
                                            btnHtml = '<div class="order-btn"><input type="button" value="查看订单" class="button button-dark order-details" data-id="' + key + '"></div></dl>';
                                        }

                                        if(userImg == "" || userImg == undefined) {
                                            html = '<dl class="all-detail"><dt><span>' + userName + '</span><p class="color-examine-status">' + orderStatus + '</p></dt><dd>';
                                        } else {
                                            html = '<dl class="all-detail"><dt><img src="' + userImg + '"><span>' + userName + '</span><p class="color-examine-status">' + orderStatus + '</p></dt><dd>';
                                        }

                                        var str = '<div class="all-list" data-id="' + key + '"><img src="' + goodsImg + '" alt=""><div class="goods-detail"><div class="details-top"><p>' + value[i].p_name + '</p>' +
                                            '<p>￥' + value[i].price + '</p></div><div class="details-bottom">';
                                        if(value[i].style) {
                                            str += '<p>规格：' + value[i].style + '</p>';
                                        } else {
                                            str += '<p></p>';
                                        }
                                        str += '<p>x' + value[i].num + '</p></div></div></div>';
                                        temp.push(str);
                                    }
                                    //                      var str1='<div class="all-list" data-id="'+orderNum+'">'
                                    var str2 = '<p class="goods-sum"><span>共' + total_num + '件商品</span><span>合计:￥' + (type_order == 'shop' ? total_price : sum_price) + '</span></p></dd>';

                                    html += temp.join("") + str2 + btnHtml;
                                    all.push(html)
                                    //                      console.log(all)
                                });
                                aim.prepend(all);

                                if(count < 3) {
                                    // str = '<dl class="not-string"><p style="text-align:center">暂无更多数据！</p></dl>';
                                    $.detachInfiniteScroll($('.infinite-scroll'));
                                    aim.find(".infinite-scroll-preloader").remove();
                                    loadings = false;
                                    aim.attr("data-flag", "true");
                                    // if(!aim.children("dl").hasClass("no-data")) {
                                    //     // aim.append(str);
                                    //     // tusi('暂无更多数据！');

                                    //     return;
                                    // }

                                    // return;
                                }

                            } else {
                                console.log(data)
                                $.alert(data.msg)
                            }
                        });
                }

                $.attachInfiniteScroll($('.infinite-scroll'));

                //监听滚动事件
                $(document).on('infinite', '.infinite-scroll', function() {
                    if(stat == 1) {
                        target = $("#tab2").children(".content-block");
                    } else if(stat == 2) {
                        target = $("#tab3").children(".content-block");
                    } else if(stat == 3) {
                        target = $("#tab4").children(".content-block");
                    }
                    // 如果正在加载，则退出
                    if(loading) return;
                    // 设置flag
                    loading = true;

                    setTimeout(function() {
                        loading = false;
                        //记录状态
                        if(target.attr("data-flag") == "true") {
                            return;
                        } else {
                            addItems(target)
                        }
                    }, 1000);
                });

                $(document).on('click', '.order_auto', function() {
                    var order_num = $(this).data('num');
                    var order = $(this).data('order');
                    var order_bind = $(this).data('bind');
                    window.location.href = '__URL__/buy_detail_shop?id=' + order_bind + '&num=' + order_num + '&order=' + order;
                });
                $(document).on('click', '.order_auto2', function() {
                    var order_num = $(this).data('num');
                    var order = $(this).data('order');
                    var order_bind = $(this).data('bind');
                    window.location.href = '__URL__/buy_detail_auto?id=' + order_bind + '&num=' + order_num + '&order=' + order;
                });
                //切换tab时初始化
                $(".buttons-tab .tab-link").bind("click", function() {
                    stat = $(this).data("stat");
                    $.attachInfiniteScroll($('.infinite-scroll'));
                    if(stat == 1) {
                        target = $("#tab2").children(".content-block");
                    } else if(stat == 2) {
                        target = $("#tab3").children(".content-block");
                    } else if(stat == 3) {
                        target = $("#tab4").children(".content-block");
                    }
                    if(loadings) {
                        return;
                    }
                    if(target.attr("data-flag") == "true") {
                        return;
                    } else {
                        addItems(target)
                        loadings = false;
                    }
                });
            });

            function GetQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);

                if(r != null) {
                    return unescape(r[2]);
                } else {
                    return null;
                }
            }
            //设置url参
            function changeURLArg(url, arg, arg_val) {
                var pattern = arg + '=([^&]*)';
                var replaceText = arg + '=' + arg_val;
                if(url.match(pattern)) {
                    var tmp = '/(' + arg + '=)([^&]*)/gi';
                    tmp = url.replace(eval(tmp), replaceText);
                    return tmp;
                } else {
                    if(url.match('[\?]')) {
                        return url + '&' + replaceText;
                    } else {
                        return url + '?' + replaceText;
                    }
                }
                return url + '\n' + arg + '\n' + arg_val;
            }
        </script>
        <!--script end-->
    </body>

</html>