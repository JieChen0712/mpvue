<!DOCTYPE html>
<html>

    <head lang="en">
        <title>我的提货单订单</title>
        <include file="Public/order" />
        <script type="text/javascript" src="__PUBLIC__/js/my_dd.js"></script>
        <script type="text/javascript">
            $(function() {
                $('.mask1').click(function() {
                    window.location.href = changeURLArg(window.location.href, "reloadtime", new Date().valueOf());
                })
            })

            function btma(id, min_multiple) {

                if(min_multiple == 0 || min_multiple == null) {
                    min_multiple = 1;
                }

                var is_checked = $("#c" + id).is(':checked');

                var old_money = $('.money').html();

                if(is_checked) {

                    number++;
                    var money = Number(old_money) + Number($("#s" + id).val()) * Number($('.price' + id).html());
                    //alert(money);
                    money = money.toFixed(2);

                    $('.number').html(number);
                    $('.money').html(money);

                } else {
                    number--;
                    var money = Number(old_money) - Number($("#s" + id).val()) * Number($('.price' + id).html());
                    money = money.toFixed(2);

                    $('.number').html(number);
                    $('.money').html(money);
                }

                //        alert(money);
            }
            //设置url参
            function changeURLArg(url, arg, arg_val) {
                var pattern = arg + '=([^&]*)';
                var replaceText = arg + '=' + arg_val;
                if(url.match(pattern)) {
                    var tmp = '/(' + arg + '=)([^&]*)/gi';
                    tmp = url.replace(eval(tmp), replaceText);
                    return tmp;
                } else {
                    if(url.match('[\?]')) {
                        return url + '&' + replaceText;
                    } else {
                        return url + '?' + replaceText;
                    }
                }
                return url + '\n' + arg + '\n' + arg_val;
            }

            //2016.10.17下单JS更改
            function orderhand() {
                var order_num = new Date().getTime();
                var pd = 0;
                var znumber = 0;
                //tusi(time);
                var j = '{$manager.count}';
                j = Number(j);
                var user_name = $('.p_name').html();
                var phone = $('.p_phone').html();
                var addre = $('.p_addre').html();
                var textarea = $(".textarea").val();

                //        if(phone == ""){
                //            tusi('请输入手机号码');
                //            return false;
                //        }
                //        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
                //        if (!reg.test(phone)) {
                //            tusi('请输入正确的手机号码');
                //            return false;
                //        }

                var p_ids = new Array();
                var p_nums = new Array();

                //        var _list_p_nums = {};
                //        var _list_p_ids = {};
                for(var i = 1; i <= j; i++) {
                    var is_checked = $('#c' + i).is(':checked');
                    //ar aaa = $('.aaa'+i+'.cc').val();
                    if(is_checked) {
                        znumber = Number(znumber) + Number($('#s' + i).val());

                        var pro_id = $('.id' + i).val();
                        var pro_num = $('#s' + i).val();

                        //            _list_p_ids["p_ids[" + i + "]"] = pro_id;  
                        //            _list_p_nums["p_nums[" + i + "]"] = pro_num;  

                        p_ids[i] = pro_id;
                        p_nums[i] = pro_num;
                    }
                };

                $.post("__APP__/Admin/Order/stock_orderhand", {
                    "p_ids": p_ids,
                    "p_nums": p_nums,
                    order_num: order_num,
                    phone: phone,
                    addre: addre,
                    user_name: user_name,
                    textarea: textarea
                }, function(data) {
                    if(data.code == 1) {
                        $('.mask1').show();
                    } else {
                        var msg = '下单失败！';
                        if(data.msg != null) {
                            msg = data.msg;
                        }
                        tusi(msg);
                    }
                });

            }

            function receiving() {
                var name = $("input[name=name]").val();
                var phone = $("input[name=phone]").val();
                var addre = $("input[name=addre]").val();
                var id = $("input[name=id]").val();
                $.post("recehand", {
                    name: name,
                    phone: phone,
                    addre: addre,
                    id: id
                }, function(data) {
                    if(data) {
                        $('.p_name').html(name);
                        $('.p_phone').html(phone);
                        $('.p_addre').html(addre);
                        $('.mask').hide();
                    } else {
                        tusi("修改失败！");
                    }
                });
            }

            function csbtm(id, v) {
                var nane = confirm("确定取消提货单订单吗？？");
                if(nane != false) {
                    $.post("stock_delorder", {
                        id: id
                    }, function(data) {
                        if(data) {
                            $('.dle' + v).remove();
                        } else {
                            tusi("删除失败！");
                        }

                    });

                }
            }

            function conutmoney() {

                var cont = '{$manager.count}';
                cont = Number(cont);
                money = 0;
                var alert_info = '';
                for(var a = 1; a <= cont; a++) {
                    var obl = document.getElementById('c' + a);
                    var is_checked = $('#c' + i).is(':checked');

                    var min_multiple = $("#min_multiple_" + a).val();

                    if(min_multiple == 0 || min_multiple == null) {
                        min_multiple = 1;
                    }

                    var s = $("#s" + a).val();

                    if(Number(s) % Number(min_multiple) != 0) {
                        s = Number(s) - Number(s) % Number(min_multiple);

                        if(s == 0 || s == null) {
                            s = min_multiple;
                        }

                        $("#s" + a).val(s);
                    }

                    if(is_checked) {

                        //tusi($(".pria"+a).val());
                        var b = Number($('.price' + a).html()) * Number(s);

                        money = Number(money) + Number(b);
                        money = money.toFixed(2);
                    }
                };
                $('.money').html(money);
                //tusi(money);
            }
        </script>
        <style>
            /*        .my_dd_cp{
            height: 120px;
        }
        .st{
            position: absolute;
            top: 60px;
            right: 5px;
            margin-right: 5px;
        }*/
            
            .footer {
                position: absolute;
                bottom: 0;
                width: 100%;
            }
        </style>
    </head>

    <body style="background-color:#f5f5f5;">
        <header class="header">
            <a href="javascript:history.go(-1);" class="a"><img src="__PUBLIC__/images/index/left_icon.png" alt=""></a>
            <p>我的提货单订单</p>
        </header>
        <div class="my_dd">
            <ul>
                <li class="li1"><span>提货单订单</span></li>
                <li class="li2"><span>我要下单</span></li>
            </ul>
        </div>
        <div class="dd1">
            <div class="sp"> <img src="__PUBLIC__/images/dd_icon3.png" alt="">选择商品 </div>

            <!--产品信息-->
            <volist name="list" id="vo">

                <div class="my_dd_cp p{$vo.id_num}">
                    <input type="checkbox" id="c{$vo.id_num}" onclick="btma({$vo.id_num},{$vo.min_multiple})">
                    <input type="hidden" id="min_multiple_{$vo.id_num}" value="{$vo.min_multiple}">
                    <input type="hidden" class="id{$vo.id_num}" value="{$vo.id}">
                    <input type="hidden" class="aaa{$vo.id_num}" value="1">
                    <span class="name{$vo.id_num}">{$vo.name}</span>

                    <!--<p><span class="price{$vo.id_num}">{$vo.price}</span>元</p>-->
                    <p class="product-price right">
                        云仓库存:<span class="red">
                    <?php echo number_format($vo['maxnum'],0);?>
            </span>
                    </p>

                    <div class="st">
                        <div class="s1" onclick="jian('{$vo.id_num}','{$vo.min_multiple}')">-</div>
                        <input max="{$vo.maxnum}" type="text" name="t" id="s{$vo.id_num}" class="s3" value="{$vo.min_multiple}" onchange="conutmoney()">
                        <div class="s2" onclick="jia('{$vo.id_num}','{$vo.min_multiple}','{$vo.maxnum}')">+ </div>
                    </div>
                </div>
            </volist>
            <!--end 产品信息-->

            <!--收货地址-->
            <div class="sp"><img src="__PUBLIC__/images/dd_icon4.png" alt="">收货地址 </div>
            <div class="dd_bg">
                <p class="p1 p_name">{$rel.name}</p>
                <p class="p p_phone">{$rel.phone}</p>
                <p class="p p_addre">{$rel.addre}</p>
            </div>
            <!--end 收货地址-->

            <!--备注-->
            <div class="sp"><img src="__PUBLIC__/images/dd_icon5.png" alt="">备注 </div>
            <textarea class="textarea"></textarea>
            <!--end 备注-->

            <!--footer-->
            <div class="footer">
                <p>共<span class="number"></span>种</p>
                <!--<p>合计￥ <span class="money"></span></p>-->
                <button type="button" onclick="orderhand()">提交</button>
            </div>
            <!--end footer-->

            <script>
                var money = 0;
                var number = 0;
                $(function() {
                    $('.money').html(money);
                    $('.number').html(number);
                })
            </script>
        </div>
        <div class="mask">
            <div class="box">
                <div class="box1">
                    <input type="text" name="name" placeholder="姓名" class="input" value="{$rel.name}">
                    <input type="text" name="phone" placeholder="电话" class="input" value="{$rel.phone}">
                    <input type="text" name="addre" placeholder="详细地址" class="input" value="{$rel.addre}">
                    <input type="hidden" name="id" value="{$manager.id}">
                    <input type="submit" value="确认" class="input1" onclick="receiving()">&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" class="input1">取消</button>
                </div>
            </div>
        </div>

        <div class="mask1"><img src="__PUBLIC__/images/yes1.png" alt=""></div>
        <div class="dd2">
            <volist name="row" id="vv">
                <div class="wrap dle{$vv.or_num}" style="height:320px;">
                    <div class="top">
                        <h2>{$vv.or_num}</h2>
                        <p class="p1">提货单订单号：{$vv.order_num}</p>
                        <!-- <p class="p2"><eq name="vv.status" value="1">待审核<else/>已审核</eq></p> -->
                        <p class="p2">
                            <if condition="$vv.status eq 1">待审核
                                <elseif condition="$vv.status eq 2" />已审核
                                <else/>已收货</if>
                        </p>
                    </div>
                    <a href="__APP__/Admin/Order/stock_ddxq?order_num={$vv.order_num}">
                        <div class="top2">
                            <p>收货人：{$vv.s_name}</p>
                            <p>收货人电话号码：{$vv.s_phone}</p>
                            <p>收货地址：{$vv.s_addre}</p>
                            <p>提货单订单日期：{$vv.time|toDate=###}</p>
                            <img src="__PUBLIC__/images/dd_icon.jpg" alt="">
                        </div>
                    </a>
                    <div class="top3">
                        <p>提货单订单金额：<span>￥{$vv.total_price}</span></p>
                        <eq name="vv.status" value="1">
                            <p class="p2" onclick="csbtm({$vv.order_num},{$vv.or_num})">取消订单</p>
                        </eq>
                        <eq name="vv.status" value="2">
                            <a href="__APP__/Admin/Order/ddxq?order_num={$vv.order_num}">
                                <p class="p2">确认收货</p>
                            </a>
                        </eq>
                    </div>
                </div>
            </volist>
        </div>
    </body>

</html>