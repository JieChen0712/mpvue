<!DOCTYPE html>
<html>
<head lang="en">
    <title>发货</title>
    <include file="Public/header"/>
    <script>var flag = "{$Think.session.ls}";</script>
    <script>var count =1;</script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
        wx.config({
            appId: '<?php echo $signPackage["appId"];?>',
            timestamp: <?php echo $signPackage["timestamp"];?>,
            nonceStr: '<?php echo $signPackage["nonceStr"];?>',
            signature: '<?php echo $signPackage["signature"];?>',
            jsApiList: [
                // 所有要调用的 API 都要加到这个列表中
                "scanQRCode"
            ]
        });
        wx.ready(function () {
          // 在这里调用 API
        });
        function ScanQRCode() {
               var obj = document.getElementById('ls');
           wx.scanQRCode({
               desc: 'scanQRCode desc',
               needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
               scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
               success: function (res) {
                   var result = res.resultStr; // 当needResult为 1 时，扫码返回的结果
                   var p = new Array();
                   var st = new Array();
                   p = result.split("p=");
                   st = result.split("st=");
                   if(p.length > 1){
                       var ptag = p[1].substring(0);

                   }
                   if(st.length > 1){
                       var status = st[1].substring(0,1);
                   }
           //ptag = xb(ptag);
           //查找小标
           $.post('__APP__/Admin/G/searchxb',{ptag:ptag},function(data){
               if (data != 'none') {
                   ptagBeg = data['ptag_beg'];
                   ptagEnd = data['ptag_end'];
               }else{
                   ptagBeg = '';
                   ptagEnd = '';
               }

                   var ptagObj = document.getElementsByName("ptag");
                       for(var i=0;i<ptagObj.length;i++)
                       {	

                               if(ptag == ptagObj[i].value){
                                   if(flag == 'yes'){
                                       obj.checked = true;
                                       setTimeout(function(){

                                                   ScanQRCode();
                                       },1000);
                                   }else{
                                       obj.checked = false;
                                   }
                                       return ;
                               }
                       }

                   var text = "";
               //text+= '<section class="section7" id="myul'+count+'"><ul class="ul1" ><li>'+count+'</li>';
               text+= '<section class="section7" id="myul'+count+'"><ul class="ul1" ><li>'+count+'</li>';
               text+= '<li>'+ptag+'</li>';
               text+= '<li class="xb">'+ptagBeg+'<br>'+ptagEnd+'</li>';
                       text+= '</li><li><img src="__PUBLIC__/images/new/delete.png" onclick="delPtag('+count+')"/>';
                       text+= '</li></ul><input type="hidden" name="ptag" value="'+ptag+'"/>';
               text+= '<input type="hidden" name="status" value="'+status+'"/></section>';
               $(".content1").append(text);
               $(".content1").show();
               count++;
               setTimeout(function(){
                           if(flag == 'yes'){
                               obj.checked = true;
                                   ScanQRCode();
                           }else{
                               obj.checked = false;
                           }
               },500);
       });

               }
           });
       }
			
    </script>
    
    </head>
    <script type="text/javascript">
    $(function(){
         $(".djlr").click(function(){
             $(".fh_mask").show();
         })
         $("#ss").click(function(){
             $("#ss").hide();
             $(".search").show();
         })
         $("#subsearch").click(function(){
        	 var s = $("input[name=search]").val();
        	 if(s == ""){
        		 tusi('请输入经销商姓名');
        		 return;
        	 }
        	 $.post('__APP__/Admin/G/searchAgent',{search:s},function(data){
        		 var html ="";
        		 if(data == null){
        			 tusi('对不起,未找到相关经销商');
        			 return false;
        		 }
        		 $.each(data,function(index,array){
        			 html+='<ul class="ul1" onclick="selectAgent('+array["id"]+');">';
                     html+='<li>'+array["id"]+'</li><li>'+array["name"]+'</li><li>'+array["levname"]+'</li></ul>'; 
        		 })
        		 $("#fh_mask .section5 .mysel").html(html);
        		 $("#fh_mask").show();
        		 $("#ss").show();
                 $(".search").hide();
        	 })
         })
         $(".btm1").click(function(){
         	
         	var agentId = $("input[name=receive_id]").val();
         	if(agentId == ""){
         		tusi('收货经销商不能为空!');
         		return;
         	}
         	//大标
         	var ptag = document.getElementsByName("ptag");
         	var managers = '';
         	for(var i=0;i<ptag.length;i++)
         	{
         		managers = managers + '|' + ptag[i].value;
         	}
         	//小标
         	var status = document.getElementsByName("status");
         	var m = '';
         	for(var j=0;j<status.length;j++)
         	{
         		m = m + '|' + status[j].value;
         	}
         	if(ptag.length == 0){
         		tusi('请扫描标签!');
         		return;
         	}
         	var receive_id = $("input[name=receive_id]").val();
         	var send_id = $("input[name=send_id]").val();
         	//发货
         	$.post('__APP__/Admin/G/stock',{ptag:managers,status:m,receive_id:receive_id,send_id:send_id},function(data){
       			if(data['state'] == 'ptag'){
       				tusi('对不起,标签号为:'+data["ptag"]+'的产品您无权发货');
       			}else if(data['state'] == 'repeat'){
       				tusi('对不起,标签号为:'+data["repeat"]+'的产品不能重复发货');
       			}else if(data == 'success'){
       				tusi('发货成功');
       				$.post('__APP__/Admin/G/clearAgent',{},function(list){
       					if(list == 'success'){
                            setTimeout(function(){
                                location.href = "__APP__/Admin/G/s"
                            },3000);
       					}
       				});
       			}else{
       				tusi('发货失败');
       			}
         	})
         	
			})
			
			$("#ls").click(function(){
				//var obj = document.getElementById('ls');
				var ls = "";
			    if(this.checked){
			    	ls = 1;
			    }else{
			    	ls = 0;
			    }
			    $.post('__APP__/Admin/G/setLs',{ls:ls},function(data){
			    	flag = data;
			    })
			});
     })
    </script>
    <script>
	    function selectAgent(id){
          $.post('__APP__/Admin/G/saveAgent',{id:id},function(data,status){
            if(data == 1){
                tusi('选择的经销商被公司禁用了！');
                $(".fh_mask").hide();
            }else{
                if(status == 'success'){
                   $(".djlr").html(data['name']);
                   $("input[name=receive_id]").val(data['id']);
                   $(".fh_mask").hide();
               }
            }  
           })
        }
	    //删除标签
	    function delPtag(count){
		   $("#myul"+count).remove();
	   }
    </script>
    <style>
        .header{
            background-color: black;
        }
    </style>
    <body style="background-color:#f5f5f5">
            <header class="header"><a href="javascript:history.go(-1);" class="a"><img src="__PUBLIC__/images/new/left_icon.png" alt=""></a><span class="djlr">点击录入新单</span></header>
	            <div class="mydiv">
                    <div class="mydiv1">
                        <div class="input_2"><input type="text"  name="search" class="one" placeholder="输入经销商姓名查询"><input id="subsearch" type="image" class="two" src="__PUBLIC__/images/new/ss_btm1.jpg"></div>
	            	<span class="span2">连扫</span>
	            	<input type='checkbox' id="ls" value="" class="input"/>
                    </div>
	            </div>
                <p style="clear:both;width:92%;margin:0 auto;font-size:20px;color:red;padding:10px 0;">*温馨提示(扫描发货时请不要超过15个标哦！)</p> 
	            <!-- <div class="search" style="display:;">
                <input style="height:50px;width:300px;"type="text" placeholder="输入all显示全部经销商" name="search"/><img id="subsearch" src="__PUBLIC__/images/new/logo5.png" style="position:relative;top:25px;left:20px;"/>
                </div> -->
	            <div class="content1" style="clear:both;display:none">
	            <section class="section7_7">
	                <ul class="ul">
	                    <li>编号</li>
	                    <li>条码</li>
                        <li>标号</li>
	                    <li>删除</li>
	                </ul>
	            </section>
            </div>
            <div style="height:71px;"></div>
            <div class="footer">
                <input type="submit"  value="发货" class="btm1">
                <input type="button"  value="扫描" class="btm2" onclick="ScanQRCode()">
            </div>
                
            <div class="fh_mask" id="fh_mask" style="display:none">
                <div class="box">
                    <p>请选择经销商..</p>
                <section class="section5">
                    <ul class="ul">
                        <li>授权号</li>
                        <li>经销商名称</li>
                        <li>经销商级别</li>
                    </ul>
                    <div class="mysel">
                    <empty name="myagent">
                    <ul class="ul1">
                   		<li></li>
                        <li style="font-size:25px;color:red;margin-left:5px;">您没有下级经销商</li>
                        <li></li>
                    </ul>
                    <else />
                    <volist name="myagent" id="my">
                    <ul class="ul1"  onclick="selectAgent({$my.id});">
                        <li>{$my.id}</li>
                        <li>{$my.name}</li>
                        <li>{$my.levname}</li>
                    </ul>
                    </volist>
                    </empty>
                    </div>
                </section>
				<input type="hidden" name="receive_id" value="{$Think.session.agentId}"/>
				<input type="hidden" name="send_id" value="{$Think.session.managerid}"/>
			
                </div>
            </div> 
            
    <script type="text/javascript">
	$(function(){
	    $('body').bind('click', function(event) {
		    var evt = event.srcElement ? event.srcElement : event.target;    
		    if(evt.id !== 'fh_mask' ){
		    	return; // 如果是元素本身，则返回
		    }else {
		    	$(".fh_mask").hide(); // 如不是则隐藏元素
            } 
		});
	});
    </script>   
    </body>
    </html>