<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>提现申请</title>
    <include file="Public/header_v3"/>
    <script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="__PUBLIC__/Admin_v3/css/refund_apply.css" />
    
</head>
<body>
<div class="page">
    <div class="content">
        <section class="withdrawals">
            <div class="card">
                <!-- <div class="wd-inf">
                    <p>提现者姓名：<span>{$manager.name}</span></p>
                    <p>微信号：<span>{$manager.wechatnum}</span></p>
                    <p>经销商等级：{$manager.levname}</p>
                    <p>提现审核人：
                        <if condition="$is_parent_audit eq 0">
                            总部
                            <else/>
                            {$manager.bossname}
                        </if>
                    </p>
                </div> -->
                
                <div class="wd-card">
                    <a href="__GROUP__/user/choose_bankcard" class="external" id="select_bank">
                        <p class="cards-title">到账账户</p>
                        <p class="cards-detail"><span id="card_type"></span><span id="card_kind">请先到个人信息添加银行卡</span></p>
                        <input type="hidden" name="card_name2" id="card_name2" value="" />
                        <input type="hidden" name="accountname" id="account_name" value="" />
                        <i class="icon icon-right"></i>
                    </a>
                </div>
                
                <div class="wd-coin">
                    <p>提现虚拟币</p>
                    <p class="coins-detail"><span>￥</span><input type="text" onkeyup="this.value=(this.value.match(/^[1-9]\d*(\.\d{0,2})?/)||[''])[0]" name="money" id="money" value="" /></p>
                    <p class="coins-total"><span>可提金额:￥<label id="minrefund">{$min_refund_money}</label></span><span><a href="#" id="refund" class="external">全部提现</a></span></p>
                </div>

                <div class="wd-btn">
                    <button class="submit-apply color-refund-apply-btn" onclick="apply()">提交申请</button>
                </div>
            </div>
        </section>

    </div>
</div>
<script>
    var defaulturl='__GROUP__/user/get_refund_bank';
    var checkBankcard = '__GROUP__/user/get_check_bank'

    var moneys='';
    var idcard='';
    var type='';
    var card_num='';
    var card_num2='';
    var card_kind='';
    var all_money='';
    var param=window.location.search;
    if(param!=""&&param!=undefined){
        if(param.indexOf("refund_money=")!=-1){
            if(param.indexOf("&",param.indexOf('refund_money='))!=-1){
                moneys=param.substring((param.indexOf('refund_money=')+13),param.indexOf("&",param.indexOf('refund_money=')))
            }else{
                moneys=param.substring((param.indexOf('refund_money=')+13),param.length);
            }
            $("#money").val(moneys);
        }
        if(param.indexOf("card_id=")!=-1){
            if(param.indexOf("&",param.indexOf('card_id='))!=-1){
                idcard=param.substring((param.indexOf('card_id=')+8),param.indexOf("&",param.indexOf('card_id=')))
            }else{
                idcard=param.substring((param.indexOf('card_id=') + 8), param.length);
			}
			$.post("__GROUP__/user/set_pay_way", {
					pay_way_id: idcard
				},
				function(data) {
					console.log(data + " - " + idcard)
					if(data != '' && data != null && data != undefined) {
						type = data.type;
						if(data.type == "银行卡") {
							card_num = data.card_number.substring(data.card_number.length - 4, data.card_number.length);
							card_num2 = data.card_number;
							card_kind = data.bank;
                                                        account_name = data.card_name;
						} else {
							card_num = data.card_account.substring(data.card_account.length - 4, data.card_account.length);
							card_num2 = data.card_account;
							card_kind = data.card_name;
                                                        account_name = '';
						}
                                                $("#account_name").val(account_name);
						$("#card_name2").val(card_num2);
						$("#card_type").text(type);
						$("#card_kind").text(card_kind + "(" + card_num + ")");
					}
			});
		}else{
			$.get(defaulturl,function(data){
				if(data != '' && data != null && data != undefined) {
						type = data.info.list[0].type;
						if(data.info.list[0].type == "银行卡") {
							card_num = data.info.list[0].card_number.substring(data.info.list[0].card_number.length - 4, data.info.list[0].card_number.length);
							card_num2 = data.info.list[0].card_number;
							card_kind = data.info.list[0].bank;
						} else {
							card_num = data.info.list[0].card_account.substring(data.info.list[0].card_account.length - 4, data.info.list[0].card_account.length);
							card_num2 = data.info.list[0].card_account;
							card_kind = data.info.list[0].card_name;
						}
						$("#card_name2").val(card_num2);
						$("#card_type").text(type);
						$("#card_kind").text(card_kind + "(" + card_num + ")");
					}
			});
		}
}else{
	$.get(checkBankcard,function(data){
		if(data.code == 1){
			$("#card_kind").text('请选择银行卡');
		}else{
			$('#select_bank').attr( 'href','__GROUP__/user/pay_way');
		}
	});
}
var applyflag = false
function apply(id) {
	if (applyflag) { return }
	applyflag = true
	// console.log($('.submit-apply').text('提交中...').css({backgroundColor:'#a0a0a0'}));
	var odata = {
			paytype: $("#card_type").text(),
            cardname:$("#card_kind").text().substring(0,$("#card_kind").text().indexOf("(")),
            cardnumber:$("#card_name2").val(),
            accountname:$("#account_name").val(),
            money:$('#money').val(),
        }
        money = Number(money);
        $.post("__URL__/money_refund_apply_submit", odata, function(res){
            console.log(odata);
            if(res.code == 1){
                tusi(res.msg);
                setTimeout(function () {
                    window.location.href='__GROUP__/user/assets'
                }, 2000);
            }else if(res.code == 2){
	            	applyflag = false
								// console.log($('.submit-apply').text('提交申请').css({backgroundColor:'#00b8ee'}));
                tusi(res.msg);
            }else if(res.code == 3){
            		applyflag = false
								// console.log($('.submit-apply').text('提交申请').css({backgroundColor:'#00b8ee'}));
                tusi(res.msg);
            }else{
                applyflag = false
//                setTimeout(function () {
//                    window.location.href='__GROUP__/user/assets'
//                }, 2000);
                tusi(res.msg);
            }
        });
    }
    function  getmoney() {
        var text=$("#minrefund").text();
        $("#money").val(text);
    }
    $("#refund").click(function () {
        getmoney()
        return false;
    })

    $("#select_bank").click(function(event){
	        	var links=$(this).attr("href");
	        	var refund_money=$('#money').val();
	        	if(refund_money==""||refund_money==null||refund_money==undefined){
	        		var param=window.location.search;
	        		var str='';
	        		if(param.indexOf("&",param.indexOf("refund_money="))!=-1){
	        			str=param.substring(param.indexOf("refund_money=")-1,param.indexOf("&",param.indexOf("refund_money=")))
	        		}else{
	        			str=param.substring(param.indexOf("refund_money=")-1,param.length)
	        		}
	        		param=param.replace(str,"");
	        		window.location.href=links+param;
	        		return false;
	        	}else{
	        		if(window.location.search==""||window.location.search==undefined||window.location.search==null){
	        			window.location.href=links+'?refund_money='+refund_money;
	        			return false;	
	        		}else{
	        			console.log(window.location.search.indexOf('refund_money='))
	        			if(window.location.search.indexOf('refund_money=')!=-1){
	        				window.location.href=links+'?refund_money='+refund_money;
	        				return false;
	        			}else{
	        				window.location.href=links+window.location.search+'&refund_money='+refund_money;
	        				return false;	
	        			}
	        			
	        		}
	        	}
	        });
</script>
</body>
</html>
