<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>银行卡</title>
    <include file="Public/header_v3" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/Admin_v3/css/bankcard.css" />
</head>

<body>
    <div class="page page-current">
        <section class="user-payinf">
            <div class="content infinite-scroll" style="margin-bottom: 0;">
                <div id="card-list">

                </div>

                <div class="infinite-scroll-preloader">
                    <div class="preloader"></div>
                </div>
            </div>

            <!--<div class="card wechat">-->
            <!--<img src="__PUBLIC__/Admin_v3/images/information/wechat.png" />-->
            <!--<p class="card-name">微信账户</p>-->
            <!--<p class="card-kind">bz123456789</p>-->
            <!--<p class="card-num"><span>***</span><span>****</span><span>****</span><span>2451</span></p>-->
            <!--</div> -->
        </section>
        <footer id="footer">
            <a href="__GROUP__/user/pay_way" class="external">
                <p class="bankcard"><span>+</span>添加新的支付方式<i class="icon icon-right pull-right"></i></p>
            </a>
        </footer>
        <!--script start-->
        <script src="__PUBLIC__/Admin_v3/js/jquery.js" type="text/javascript" charset="utf-8"></script>
        <script src="__PUBLIC__/Admin_v3/js/light7.min.js" type="text/javascript" charset="utf-8"></script>

        <script>
            $(function () {
                $('.bcard').click(function () {
                    var pay_way_id = $(this).data('id');
                    $.post('set_pay_way_status', {
                        pay_way_id: pay_way_id
                    }, function (res) {
                        if (res.code == 1) {
                            tusi(res.msg());
                            setTimeout(function () {
                                    //                                if (return_url) {
                                    //                                    window.location.href = return_url;
                                    //                                }
                                },
                                2000);
                        }
                    });
                })
            });
        </script>

        <script type="text/javascript">
            var loading = false;
            var bankcardurl = '__GROUP__/user/get_bankcard';
            var icbcImg = '__PUBLIC__/Admin_v3/images/information/icbc.png';
            var wechatImg = '__PUBLIC__/Admin_v3/images/information/wechat.png';
            var appilyImg = '__PUBLIC__/Admin_v3/images/information/aplipay.png';
            var usedImg = '__PUBLIC__/Admin_v3/images/information/20.png';
            var changeCard = '__GROUP__/user/set_pay_way_status';
            var page = 1;
            var bankcard = {
                imgurl: '',
                cardName: '',
                cardKind: '',
                cardNum: '',
                Oclass: ''
            }
            $.attachInfiniteScroll(".infinite-scroll");
            getBankcard();

            function getBankcard() {
                $.post(bankcardurl, {
                        page_num: page
                    },
                    function (data) {
                        console.log(data);
                        if (data.info.list == null) {
                            $(".infinite-scroll-preloader").remove();
                            $.detachInfiniteScroll($('.infinite-scroll'));
                            var str = '<p style="color:white;text-align:center">暂无更多数据！</p>'
                            $("#card-list").append(str);
                            return false;
                        }
                        var cards = [];
                        $.each(data.info.list, function (key, value) {
                            //							if(data.info)
                            var str = '';
                            var strused = '';
                            if (value.status == 1) {
                                strused =
                                    '<img class="default show" src="__PUBLIC__/Admin_v3/images/information/20.png" alt="">';
                            } else {
                                strused =
                                    '<img class="default hide" src="__PUBLIC__/Admin_v3/images/information/20.png" alt="">';
                            }
                            console.log(typeof value.card_account)
                            if (value.type == "银行卡") {
                                str = '<div class="card icbc bcard" data-id="' + value.id + '"><img src="' +
                                    icbcImg + '" />' + strused + '<p class="card-name">' + value.bank +
                                    '</p>' +
                                    '<p class="card-kind">' + value.card_type +
                                    '</p><p class="card-num"><span>***</span><span>****</span><span>****</span>' +
                                    '<span>' + value.card_number.substring(value.card_number.length - 4,
                                        value.card_number.length) + '</span></p></div>';
                            } else if (value.type == "微信支付") {
                                str = '<div class="card wechat bcard" data-id="' + value.id +
                                    '"><img src="' + wechatImg + '" />' + strused + '<p class="card-name">' +
                                    value.type + '</p>' +
                                    '<p class="card-kind">' + value.card_name +
                                    '</p><p class="card-num"><span>***</span><span>****</span><span>****</span>' +
                                    '<span>' + value.card_account.substring(value.card_account.length - 4,
                                        value.card_account.length) + '</span></p></div>';
                            } else if (value.type == "支付宝") {
                                str = '<div class="card aplipay bcard" data-id="' + value.id +
                                    '"><img src="' + appilyImg + '" />' + strused + '<p class="card-name">' +
                                    value.type + '</p>' +
                                    '<p class="card-kind">' + value.card_name +
                                    '</p><p class="card-num"><span>' + value.card_account.substring(0, 3) +
                                    "***" + value.card_account.substring(value.card_account.length - 5,
                                        value.card_account.length) +
                                    '</span></p></div>';
                            }
                            cards.push(str);
                        });
                         page = page + 1;
                        $("#card-list").append(cards);
                        loading = false;
                        if(data.info.list.length<10){
                          $(".infinite-scroll-preloader").remove();
                            $.detachInfiniteScroll($('.infinite-scroll'));
                            var str = '<p style="color:white;text-align:center">暂无更多数据！</p>'
                            $("#card-list").append(str);
                            return false;
                        }
                    });
            }

            $(document).on('infinite', '.infinite-scroll', function () {

                // 如果正在加载，则退出
                if (loading) return;

                // 设置flag
                loading = true;
                getBankcard();
            });

            $(document).ready(function () {
                $(document).on('click', '.card', function () {
                    $('.card .default').addClass('hide').removeClass('show');
                    $(this).find('.default').addClass('show').removeClass('hide');
                    //			        console.log($(this).data("id"));
                    var cid = $(this).data("id");
                    setTimeout(function () {
                        var param = window.location.search;
                        if (param.indexOf('return_url=/sale/mallorder/bonus_withdraw') != -1) {
                            window.location.href = '/viska/sale/mallorder/bonus_withdraw' +'&card_id=' + cid;
                        } else if (param.indexOf('card_id=') != -1) {
                            console.log(param.indexOf('card_id='))
                            console.log(param.indexOf("&", param.indexOf('card_id=')))
                            if (param.indexOf("&", param.indexOf('card_id=')) != -1) {
                                str = param.substring(param.indexOf('card_id='), param.indexOf(
                                    "&", param.indexOf('card_id=')))
                            } else {
                                str = param.substring(param.indexOf('card_id='), param.length)
                            }
                            param = param.replace(str, "");
                            if (param.indexOf("?", (param.indexOf('card_id=') - 1)) == -1) {
                                window.location.href = '__GROUP__/Funds/refund_apply' + param +
                                    'card_id=' + cid;
                            } else {
                                window.location.href = '__GROUP__/Funds/refund_apply' + param +
                                    '&card_id=' + cid;
                            }
                        } else if (param != "") {
                            window.location.href = '__GROUP__/Funds/refund_apply' + param +
                                '&card_id=' + cid;
                        } else {
                            window.location.href = '__GROUP__/Funds/refund_apply?card_id=' +
                                cid;
                        }

                    }, 1000)
                    //			        window.location.href=___
                })
            });


            function GetQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }
        </script>

        <!--script end-->
    </div>
</body>

</html>