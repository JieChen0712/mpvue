<html>

  <head>
    <style>
        .form-control {
            display: inline-block;
            width: 107px;
            height: 20px;
            vertical-align: middle;
            margin-bottom: 3px;
        }
        #addtag div {
            margin-left: 82px;
        }

        /*小屏幕样式*/

        @media screen and (max-width: 768px) {
            .edit-wrapper .layui-content .layui-form .items .form-text {
                margin-left: 10px;
            }
            .form_submit {
                margin-left: 10px;
            }
        }
            
        @media screen and (min-width: 768px) {
            .special-select {
                margin-left: 5px;
            }
        }
    </style>
  </head>

  <body>

    <div class="container-fluid edit-wrapper">
      <header class="edit-title">
        <blockquote class="layui-elem-quote">
          <span class="title">系统大标出库</span>
        </blockquote>
      </header>

      <div class="layui-content">
          <form class="layui-form layui-box" action="__URL__/e_bigStock" data-auto="false" method="post" id="proform">


          <div class="layui-form-item items">
            <label class="form-text">获取数据：</label>
            <div class="form-right">
              <input class="input-inf2" type="text" name="m_url" id="m_url" autocomplete="off" title="请输入标签" placeholder="输入标签后需要按确定">
              <input onclick="return get_m_url();" class="layui-btn layui-btn-normal" type="button" value="确认" style="display: block;margin-left: 10px;"/>
              <input type="hidden" name="checkUrl" id="checkUrl">
              <span id="urlTip"></span>
            </div>
          </div>



          <div class="layui-form-item  items searchagent">
            <label class="form-text">收货代理：</label>
            <div class="form-right">
              <div class="layui-input-inline three-select">
                <select name="level" id="level" lay-verify="stock_level" lay-filter="level">
                  <option value="">请选择等级</option>
                  <egt name="level_num" value="1"><option value="1">{$level_name.1}</option></egt>
                  <egt name="level_num" value="2"><option value="2">{$level_name.2}</option></egt>
                  <egt name="level_num" value="3"><option value="3">{$level_name.3}</option></egt>
                  <egt name="level_num" value="4"><option value="4">{$level_name.4}</option></egt>
                  <egt name="level_num" value="5"><option value="5">{$level_name.5}</option></egt>
                  <egt name="level_num" value="6"><option value="6">{$level_name.6}</option></egt>
                </select>
              </div>
              <div class="layui-input-inline three-select">
                  <select name="receive_id" class="mylevel" lay-verify="stock_agent_id">
                  <option value="">请选择代理</option>
                </select>
              </div>
              <div class="layui-input-inline three-select special-select">
                <input onclick="search();" class="layui-btn layui-btn-normal" type="button" value="搜索" />
              </div>
            </div>
          </div>

    <div class="layui-form-item items mysearch" style="display: none;">
      <label class="form-text">收货代理：</label>
      <div class="form-right">
        <div class="layui-input-inline three-select">
          <select name="modules" lay-verify="required" lay-search="" id="m_search" lay-filter="m_search"></select>
          <!--<input type="hidden" id='receive_id' name="receive_id">-->
        </div>
      </div>

    </div>

          <div class="layui-form-item  items">
            <label class="form-text">选择模板：</label>
            <div class="form-right">
              <div class="layui-col-sm6">
                <div class="layui-col-sm6">
                  <div class="layui-input-inline three-select">
                    <select name="templet_id" class="input-inf2 layui-input" lay-verify="stock_templet_id" lay-search="">
                      <volist name="templet" id="t">
                        <option value="{$t.id}">{$t.name}</option>
                      </volist>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="layui-form-item items">
            <label class="form-text">首末标签：</label>
            <div id="addtag"></div>
<!--            <div class="form-right">
              <input class="input-inf2" id="addtag" type="text" readonly="readonly" style="border: none;">
            </div>-->
          </div>
          <div class="layui-form-item  items">
            <label class="form-text"></label>
            <div class="form-right">
              <button id="form_submit" class="layui-btn form_submit" lay-submit="" lay-filter="demo1">立即提交</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-ui.js" ></script>
    <script type="text/javascript">
        form.render();
        
        function deleteitem(ob) {
            ob.parentNode.parentNode.removeChild(ob.parentNode);
        }

        function get_m_url(){
            getPtag();
        }
        
        function search() {
            $(".searchagent").hide();
            $(".searchagent").remove();
            $(".mysearch").show();
            $(".search").hide();
        }
        
        //监听回车事件
        $(document).ready(function () {
            $("#m_url").keydown(function (event) {
                if (event.which == 13) {
                    getPtag();
                }
            });
            
            //删除标签事件
            $("#del").click(function () {
                this.remove();
            });

//            $("#form_submit").click(function () {
//                var searchagent = $('.mylevel').val();
//                var agent = $("input[name=receive_id]").val();
//                if (searchagent == 0 || searchagent == undefined) {
//                    if (agent == "") {
//                        layer.msg('收货代理不能为空！');
//                        return false;
//                    }
//
//                } else {
//                    $("input[name=receive_id]").val(searchagent);
//                }
//                $("#proform").submit();
//            });
        });
        
        //获取标签
        function getPtag() {
            var m_url = $("#m_url").val();
            if (m_url) {
                $.ajax({
                    type: "post",
                    url: "__URL__/bigPtag",
                    dataType: 'json',
                    data: 'm_url=' + m_url,
                    success: function (json) {
                        //layer.msg(json.username+'\n'+json.password); //把php中的返回值（json.username）给 alert出来
                        if (json != null) {
                            var m_html = "";
                            m_html = "<div><input class='form-control' type='text' readonly name='pbeg[]' value='" + json.ptag_beg + "' />~<input class='form-control' type='text' readonly name='pend[]' value='" + json.ptag_end + "'/>（共<b id='pronum'>" + json.ptag_total + "</b>件）<input type='hidden' value='" + json.ptag_total + "' name='product_num[]'/><input type='hidden' value='" + json.ptag_name + "' name='ptag_name[]'/><input class='btn btn-danger' onclick='deleteitem(this)' type='button' value='删除'/></div>";
                            $('#addtag').append(m_html);
                            $("#m_url").val('');
                            $('#urlTip').html("");
                        } else {
                            $('#urlTip').html("<font color='red'>标签不存在</font>");
                        }
                    }
                });
            } else {
                $('#urlTip').html("");
            }
        }
        
        //select联动事件监听
        $(function () {
            form.on('select(level)', function(data){
                var level = data.value;
                var html = '<option value="">请选择代理</option>';
                if(level != ""){
                    $.post("__APP__/Radmin/Stock/getAgent", {
                        level: level
                    }, function (data) {
                        if (data != 'none') {
                            var text = '';
                            $.each(data, function (index, array) {
                                text += '<option value="' + array["id"] + '">' + array["name"] + '</option>';
                            })
                            $(".mylevel").html(text);
                        } else {
                            $(".mylevel").html(html);
                        }
                        form.render('select');
                    })
                  }else{
                      $('.mylevel').empty().append(html);
                  }
              });
        });
        
        
        $('#m_search~.layui-form-select>.layui-select-title>.layui-input').attr('placeholder','请输入搜索内容');
        $(document).on('input','#m_search~.layui-form-select>.layui-select-title>.layui-input',function(){
          var _this = this;
          var aim = $('#m_search');
          if($(_this).val().trim().length<1){
            aim.empty();
            form.render();
            $('#m_search~.layui-form-select>.layui-select-title>.layui-input').attr('placeholder','请输入搜索内容');
            return;
          }
          $.ajax({
          	type:"post",
          	url:"__URL__/agent",
          	async:true,
          	data:{term:$(_this).val()},
          	success:function(data){
          	  var html = '';
          	  var count = 50;
          	  $.each(data, function(key,value) {
          	    if(count>0){
          	      html += '<option value="'+value.id+'">'+value.name+'---'+value.levname+'</option>';
          	  	  count --;
          	    }else{
          	      return;
          	    }
          	  });
          	  aim.empty().append(html);
          	  form.render('select');
          	  $('#m_search~.layui-form-select').addClass("layui-form-selected");
          	  $('#m_search~.layui-form-select>.layui-select-title>.layui-input').focus().val($(_this).val()).attr('placeholder','请输入搜索内容')
          	}
          });
        })
        
        form.on('select(m_search)',function(data){
            var id = data.value;
            $('#receive_id').val(id);
        });
        
//      $("#agent").autocomplete({
//          minLength: 1,
//          autoFocus: true,
//          source: function (request, response) {
//              $.ajax({
//                  url: "__URL__/agent",
//                  dataType: "json",
//                  data: {
//                      term: request.term,
//                  },
//                  success: function (data) {
//                      response($.map(data, function (item) {
//                          return {
////						data: item,
//                              label: item.name + '---' + item.levname,
//// 						value :item.agent_name,
//                              ID: item.id,
////						province: item.agent_province,
////						city: item.agent_city,
//                          }
//                      }));
//                  }
//              });
//          },
//          select: function (event, ui) {
////		$('#order_address').val(ui.item.address+item.agent_city);
//              $('#receive_id').val(ui.item.ID);
//          }
//      });
//
//        $("#templet").autocomplete({
//            minLength: 1,
//            autoFocus: true,
//            source: function (request, response) {
//                $.ajax({
//                    url: "__URL__/templet",
//                    dataType: "json",
//                    data: {
//                        term: request.term,
//                    },
//                    success: function (data) {
//                        response($.map(data, function (item) {
//                            return {
//                                data: item,
//                                label: item.name,
//                                ID: item.id,
//                            }
//                        }));
//                    }
//                });
//            },
//            select: function (event, ui) {
//                $('#templet_id').val(ui.item.ID);
//            }
//        });
    </script>
    
  </body>
</html>