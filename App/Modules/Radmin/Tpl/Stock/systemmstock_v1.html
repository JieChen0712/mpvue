<layout name="Public/public" />

<head>
    
<link href="__PUBLIC__/Admin/css/jquery-ui.css" type="text/css" rel="stylesheet" />
<link href="__PUBLIC__/css/index.css" rel="stylesheet">
<link href="__PUBLIC__/Admin/css/z/my.css" rel="stylesheet">
<script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-ui.js" ></script>
<script type="text/javascript">

function deleteitem(ob){
	ob.parentNode.parentNode.removeChild(ob.parentNode);
}

$(document).ready(function(){
	
	$("#m_url").keydown(function(event){ 
		if(event.which == 13){
			getPtag();
		}
	});
	
	$("#del").click(function(){
		this.remove();
	});
	
	$("#form_submit").click(function(){
		var searchagent = $('.mylevel').val();
		var templet = $('#mytemplet').val();
		var agent = $("input[name=receive_id]").val();
		var flag = 1;
		if(searchagent == 0 || searchagent == undefined){
			if(agent == ""){
				alert('收货经销商不能为空！');
				return false;
			}
			
		}else{
			$("input[name=receive_id]").val(searchagent);
		} 
		if(templet == ""){
			alert('模板不能为空！');
			return false;
		}
		//add by z
	 	$(".tag-beg").each(function(){
	 		if( "" == $(this).val()){
	 			alert('起始标签不能为空');
	 			flag = 2;
	 			return false;
	 		}
		})
		$(".tag-end").each(function(){
	 		if( "" == $(this).val()){
	 			alert('结束标签不能为空');
	 			flag = 2;
	 			return false;
	 		}
		})
		if(flag != 2){
			var blen = $(".tag-beg").length;
			var elen = $(".tag-end").length;
			if(blen != elen){
				alert('首尾标签数量不一致');
				return false;
			}
			for(var i = 1;i<=blen;i++){
				var beg = $(".check-beg"+i).val();
				var end = $(".check-end"+i).val();
				if(beg - end >0){
					alert('起始标签不能大于结束标签');
					return false;
				}
			}
			//:add by z
			$("#proform").submit();
		}
	});
}); 

/*function getPtag(){ 
	var m_url = $("#m_url").val();
	if(m_url){
		$.ajax({ 
			type: "post", 
			url : "__URL__/bigPtag",
			dataType:'json',
			data: 'm_url='+m_url,
			success: function(json){
				//alert(json.username+'\n'+json.password); //把php中的返回值（json.username）给 alert出来 
				if(json != null){
					var m_html = "";
					m_html = "<div><input type='text' readonly name='pbeg[]' value='"+json.ptag-beg+"' />~<input type='text' readonly name='pend[]' value='"+json.ptag-end+"'/>（共<b id='pronum'>"+json.ptag_total+"</b>件）<input type='hidden' value='"+json.ptag_total+"' name='product_num[]'/><input type='hidden' value='"+json.ptag_name+"' name='ptag_name[]'/><input onclick='deleteitem(this)' type='button' value='删除'/></div>";
					$('#addtag').append(m_html);
					$("#m_url").val('');
					$('#urlTip').html("");
				}else{
					$('#urlTip').html("<font color='red'>标签不存在</font>");
				}
			}
		}); 
	}else{
		$('#urlTip').html("");
	}
}*/
var num = 2;
function addxb(){
	var m_html = "";
		m_html = "<div><input type='text' name='pbeg[]' class='tag-beg check-beg"+num+"'/>~<input type='text' name='pend[]' class='tag-end check-end"+num+"'/><input onclick='deleteitem(this)' type='button' value='删除'/></div>";
	$('#addtag').append(m_html);
	num++;
}

function addli(){
    var m_html = "";
    m_html = "<li class='list-group-item'><input type='text' name='pbeg[]' class='tag-beg check-beg"+num+"'/>~<input type='text' name='pend[]' class='tag-end check-end"+num+"'/><input onclick='deleteitem(this)' type='button' value='删除'/></li>";
    $('#addli').after(m_html);
    num++;
}

</script>

<script>
$(function(){
	$("#level").change(function(){
		var level = $(this).val();
		var html = '<option value="0">请选择经销商</option>';
		if(level == 0){
			$(".mylevel").html(html);
			return;
		}
		$.post("__APP__/Radmin/Stock/getAgent",{level:level},function(data){
			if(data != 'none'){
				var text = '';
				$.each(data,function(index,array){
					text +='<option value="'+array["id"]+'">'+array["name"]+'</option>';
				})
				$(".mylevel").html(text);
			}else{
				$(".mylevel").html(html);
			}
		})
	})
})
</script>
<script type="text/javascript">
	function search(){
		$(".searchagent").hide();
		$(".searchagent").remove();
		$(".mysearch").show();
		$(".search").hide();
	}
</script>
</head>

<h1 class="page-header">
    系统小标出库
</h1>


<form class="form-inline" method="post" action="__URL__/m_mStock" id="proform">
<ul class="list-group">
    
  <li class="list-group-item searchagent">
      收货经销商：
      
      <select name="level" id="level">
            <option value="0">请选择经销商等级</option>
            <egt name="level_num" value="1"><option value="1">{$level_name.1}</option></egt>
            <egt name="level_num" value="2"><option value="2">{$level_name.2}</option></egt>
            <egt name="level_num" value="3"><option value="3">{$level_name.3}</option></egt>
            <egt name="level_num" value="4"><option value="4">{$level_name.4}</option></egt>
            <egt name="level_num" value="5"><option value="5">{$level_name.5}</option></egt>
            <egt name="level_num" value="6"><option value="6">{$level_name.6}</option></egt>
        </select>
        <select name="receive_id" class="mylevel">
            <option value="0">请选择经销商</option>
        </select>
      
      <button type="button" class="btn btn-default search" value="" onclick="search();">搜索经销商</button>
  </li>
  <li class="list-group-item mysearch" style="display:none">
      收货经销商：
      <input type="text" id="agent" placeholder="请输入经销商姓名" onmouseup="this.select();" maxlength="80" style="width:300px;" required/>
        <input type="hidden" id='receive_id' name="receive_id">
  </li>
  
  <li class="list-group-item">
  选择模板：
    <select name="templet_id">
        <volist name="templet" id="t">
            <option value="{$t.id}">{$t.name}</option>
        </volist>
    </select>
    <input type="text" style="display:none" placeholder="默认不用选择" onmouseup="this.select();" maxlength="80" style="width:300px;"/>
  </li>
  
  <li class="list-group-item" id="addli">
      首末标签：
      
      <input type='text' name='pbeg[]' class="form-control tag-beg check-beg1"/>~<input type='text' name='pend[]' class="form-control tag-end check-end1"/>
      
      <button type="button" class="btn btn-default search" value="" onclick="addli();">添加</button>
  </li>
  
  <li class="list-group-item">
      <input id="form_submit" class="btn btn-default" value="提交" type="button"/>
  </li>
  
</ul>
</form>

	

<script type="text/javascript">
$("#agent").autocomplete({
	minLength:1,
	autoFocus:true, 
	source: function(request, response){
		$.ajax({
			url: "__URL__/agent", 
			dataType: "json",
			data: {
				term: request.term,
			},
			success: function(data){
				response($.map(data,function(item){
					return {
//						data: item,
						label :item.name+'---'+item.levname,
// 						value :item.agent_name,
						ID: item.id,
//						province: item.agent_province,
//						city: item.agent_city,
					}
				}));
			} 
		}); 
	},
	select: function(event, ui){
//		$('#order_address').val(ui.item.address+item.agent_city);
		$('#receive_id').val(ui.item.ID);
	}
});

$("#templet").autocomplete({
	minLength:1,
	autoFocus:true, 
	source: function(request, response){
		$.ajax({
			url: "__URL__/templet", 
			dataType: "json",
			data: {
				term: request.term,
			},
			success: function(data){
				response($.map(data,function(item){
					return {
						data: item,
						label :item.name,
						ID: item.id,
					}
				})); 
			} 
		}); 
	},
	select: function(event, ui){
		$('#templet_id').val(ui.item.ID);
	}
});
</script>