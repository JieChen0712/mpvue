<layout name="Public/public" />

<link href="__PUBLIC__/css/index.css" rel="stylesheet">
<script type="text/javascript" src="__PUBLIC__/Admin/js/agentcode.js"></script>

<script type="text/javascript" src='__PUBLIC__/Js/jquery.js'></script> 


<h1 class="page-header">为经销商《{$dis_info.name}》下单</h1>


<!--右边内容-->
<table class="table table-condensed table-hover table-responsive table-bordered">
    <tbody>
        <tr>
            <td>
                经销商名字：
            </td>
            <td>
                {$dis_info.name}
            </td>
        </tr>

        <tr>
            <td>
                经销商等级：
            </td>
            <td>
                {$dis_info.levname}
            </td>
        </tr>

        <tr>
            <td>
                微信号：
            </td>
            <td>
                {$dis_info.wechatnum}
            </td>
        </tr>

        <tr class="info">
            <td>
                账户余额：
            </td>
            <td>
                {$recharge_money}
            </td>
        </tr>
    </tbody>
</table>

<!--产品信息-->
<form class="form-inline" role="form" >
    <table class="table table-condensed table-hover table-responsive table-bordered">
        <volist name="templet_info" id="vo">
            <tr>
                <td>
                    <label class="checkbox-inline" >
                        <input type="checkbox" id="tem_check{$vo.id_num}" onclick='cal_count();' >
                        {$vo.name}
                    </label>
                </td>
                <td>
                    <input class="form-control" type="number" name="t" id="tem_num{$vo.id_num}" value="1" onchange="cal_price('{$vo.id_num}',false);">
                    价格：
                    <span id="cal_price{$vo.id_num}">{$vo.price}</span>元
                    
                    <!--单价-->
                    <input type="hidden" id="price{$vo.id_num}" value="{$vo.price}">
                    <!--产品ID-->
                    <input type="hidden" id="tem_id{$vo.id_num}" value="{$vo.id}">
                    <!--<input type="hidden" class="aaa{$vo.id_num}" value="1">-->
                </td>
            </tr>
        </volist>
        <!--end 产品信息-->

        <tr>
            <td>接单经销商</td>
            <td>总部（总部后台下单，其发货都由总部发出）</td>
        </tr>
            
            
        <!--收货地址-->
        <tr>
            <td>
        收货地址：
        </td>
        <td>
            <p class="receiving p_name">收货人：<span id='p_name'>{$receiving_info.name}</span></p>
            <p class="receiving p_phone">手机：<span id='p_phone'>{$receiving_info.phone}</span></p>
            <p class="receiving p_addre">地址：<span id='p_addre'>{$receiving_info.addre}</span></p>
            <empty name="receiving_info">
                <input onclick='show_receiving_input();' class="btn btn-default receiving" value="请填写收货地址" type="button">
                <else />
                <input onclick='show_receiving_input();' class="btn btn-default receiving" value="更改" type="button">
            </empty>
            
            
            <div class="receiving_input">
            <label class="sr-only" for="p_name">收货人</label>
            <input type="text" class="form-control" name="p_name" value='{$receiving_info.name}' id="p_name" placeholder="收货人">
            </div>
            
            <div class="receiving_input">
            <label class="sr-only" for="p_phone">手机</label>
            <input type="text" class="form-control" name="p_phone" value='{$receiving_info.phone}' id="p_phone" placeholder="手机">
            </div>
            
            <div class="receiving_input">
            <label class="sr-only" for="p_addre">地址</label>
            <input type="text" class="form-control" name="p_addre" value='{$receiving_info.addre}' id="p_addre" placeholder="地址">
            </div>
            
            <input class="btn btn-default receiving_input" onclick='receiving();' value="确定" type="button">
        </td>
        </tr>
        <!--end 收货地址-->
        
        <!--备注-->
        <tr>
            <td>
                备注：
            </td>
            <td>
                <textarea id='textarea' class="form-control"></textarea>
            </td>
        </tr>
        <!--end 备注-->

        <tr class="info">
            <td>
                订单汇总：
            </td>
            <td>
                共<span id='count_number'>0</span>种，合计￥<span id='count_money'>0</span>
            </td>
        </tr>
        
        
        <tr>
            <td colspan='2'>
                <input type="hidden" id='uid' class="uid" value="{$dis_info.id}">
                <input onclick='return orderhand()' class="btn btn-primary" id="submit" value="提交订单" type="button">
            </td>
        </tr>
        </tbody>
    </table>
</from>


<script>

    $(".receiving_input").hide();
    
    function show_receiving_input(){
        $(".receiving").hide();
        $(".receiving_input").show();
    }
    
    function hide_receiving_input(){
        $(".receiving").show();
        $(".receiving_input").hide();
    }
    
    function receiving(){
        var name = $("input[name=p_name]").val();
        var phone = $("input[name=p_phone]").val();
        var addre = $("input[name=p_addre]").val();
        var id = $("#uid").val();
        $.post("recehand",{name:name,phone:phone,addre:addre,id:id},function(data){
            if(data){
                $('#p_name').html(name);
                $('#p_phone').html(phone);
                $('#p_addre').html(addre);
                hide_receiving_input();
                alert("修改成功！");
            }else{
                alert("修改失败！");
            }
        });
    }
    
    
    //计算单价
    function cal_price(id_num,returnval){
        
        var tem_num = $("#tem_num"+id_num).val();
        var price = $("#price"+id_num).val();
        
        var cal_price = mul(tem_num,price);
        
        if( returnval==true ){
            return cal_price;
        }
        
        $("#cal_price"+id_num).html(cal_price);
        
        cal_count();
    }
    
    //计算汇总
    function cal_count(){
        
        var znumber = 0;
        var number = 0;
        
        var j = '{$templet_count}';
            j = Number(j);
        
        for(var i = 1; i <= j; i++){
            var obl = document.getElementById('tem_check'+i);
            if(obl.checked){
                var znumber_one = cal_price(i,true);
                znumber = add(znumber,znumber_one);
                number++;
            }
        };
        
        $("#count_money").html(znumber);
        $("#count_number").html(number);
    }
    
    
    
    
    //2016.10.17下单JS更改
    function orderhand(){
        var order_num = new Date().getTime();
        var pd = 0;
        var znumber = 0;
        //alert(time);
        var j = '{$templet_count}';
            j = Number(j);
        var user_name = $('#p_name').html();
        var phone = $('#p_phone').html();
        var addre = $('#p_addre').html();
        var textarea = $("#textarea").val();
        var uid = $("#uid").val();
        
        if(phone == ""){
            alert('请输入手机号码');
            return false;
        }
        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        if (!reg.test(phone)) {
            alert('请输入正确的手机号码');
            return false;
        }
        
        var p_ids=new Array();
        var p_nums=new Array();
        
        var is_check = false;
        
        for(var i = 1; i <= j; i++){
            var obl = document.getElementById('tem_check'+i);
            if(obl.checked){
                is_check = true;
                //var znumber = cal_price(i,true);
                
                var pro_id = $('#tem_id'+i).val();
                var pro_num = $('#tem_num'+i).val();
                
                p_ids[i] = pro_id;
                p_nums[i] = pro_num;
            }
        };
        
        if( !is_check ){
            alert('请选择产品！');
            return false;
        }
        
        
        $("#submit").attr('disabled', 'disabled');
        $("#submit").val('正在提交中');
        $.post("__GROUP__/order/set_order_submit",{"p_ids":p_ids,"p_nums":p_nums,uid:uid,order_num:order_num,phone:phone,addre:addre,user_name:user_name,textarea:textarea},function(data){
            $("#submit").attr('disabled', false);
            $("#submit").val('提交订单');
            if(data.code==1){
                alert('提交订单成功！');
                window.location.href='__GROUP__/order/index?order_num='+data.order_num;
            }else{
                var msg = '下单失败！';
                if( data.msg != null ){
                    msg = data.msg;
                }
                alert(msg);
            }
            
        });
        
        
    }
    
    
    
    
    
    
    //+
    function add(a, b) {
        var c, d, e;
        try {
            c = a.toString().split(".")[1].length;
        } catch (f) {
            c = 0;
        }
        try {
            d = b.toString().split(".")[1].length;
        } catch (f) {
            d = 0;
        }
        return e = Math.pow(10, Math.max(c, d)), (mul(a, e) + mul(b, e)) / e;
    }

    //-
    function sub(a, b) {
        var c, d, e;
        try {
            c = a.toString().split(".")[1].length;
        } catch (f) {
            c = 0;
        }
        try {
            d = b.toString().split(".")[1].length;
        } catch (f) {
            d = 0;
        }
        return e = Math.pow(10, Math.max(c, d)), (mul(a, e) - mul(b, e)) / e;
    }

    //*
    function mul(a, b) {
        var c = 0,
            d = a.toString(),
            e = b.toString();
        try {
            c += d.split(".")[1].length;
        } catch (f) {}
        try {
            c += e.split(".")[1].length;
        } catch (f) {}
        return Number(d.replace(".", "")) * Number(e.replace(".", "")) / Math.pow(10, c);
    }

    // /
    function div(a, b) {
        var c, d, e = 0,
            f = 0;
        try {
            e = a.toString().split(".")[1].length;
        } catch (g) {}
        try {
            f = b.toString().split(".")[1].length;
        } catch (g) {}
        return c = Number(a.toString().replace(".", "")), d = Number(b.toString().replace(".", "")), mul(c / d, Math.pow(10, f - e));
    }

</script>