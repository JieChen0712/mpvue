<layout name="Public/public" />

    <!--    <link href="__PUBLIC__/Admin/css/jquery-ui.css" type="text/css" rel="stylesheet" />
        <link href="__PUBLIC__/css/back/index.css" rel="stylesheet">
        <link href="__PUBLIC__/Admin/css/toggle.css" rel="stylesheet">
        
        <script type="text/javascript" src="__PUBLIC__/Admin/js/agentcode.js"></script>
        <script type="text/javascript" src='__PUBLIC__/js/jquery.js'></script>
        <script type="text/javascript" src='__PUBLIC__/js/index.js'></script>
        <script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-ui.js" ></script>-->

    <script type="text/javascript">
//        var level_name1 = "{$level_name.1}";
//        var level_name2 = "{$level_name.2}";
//        var level_name3 = "{$level_name.3}";
//        var level_name4 = "{$level_name.4}";
//        var level_name5 = "{$level_name.5}";
//        var level_name6 = "{$level_name.6}";
        var level_num = "{$level_num}";
//        var upgradeUrl = '{:U(GROUP_NAME . "/Manager/upgrade")}/';
//        var searchUrl = "{:U(GROUP_NAME . '/Manager/search',array('id' => 8,'keyword' => '9'))}";
    </script>

    <script type="text/javascript">
        function sc($name, $ulr) {
            //利用对话框返回的值 （true 或者 false）
            if (confirm("该经销商可能有下属经销商,该经销商的订单信息也会同时删除,请谨慎操作。您确定要删除" + $name + "吗？")) {
                window.location.href = $ulr;
            } else {
                return false;
            }
        }
    </script>

<h1 class="page-header">
    <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
        <if condition="$key_left_num eq $level">{$vo_left_name}列表</if>
    </foreach>
</h1>

<div class="row">
    <div class="col-xs-12 col-md-10">
        <!--搜索表单-->
        <form class="form-inline" role="form" method="get" action="__URL__/index">
            <div class="form-group">
                <label class="sr-only" for="pname">审核人</label>
                <input type="text" class="form-control" name="pname" id="pname" placeholder="审核人">
                <label class="sr-only" for="name">经销商</label>
                <input type="text" class="form-control" name="name" id="name" placeholder="经销商姓名或手机或微信号">
                <!--<label class="sr-only" for="phone">手机</label>-->
                <!--<input type="text" class="form-control" name="phone" id="phone" placeholder="手机">-->
                <label class="sr-only" for="address">地区</label>
                <input type="text" class="form-control" name="address" id="address" placeholder="地区">
            </div>
            <input type="hidden" name="level" value="{$level}"/>
            <button type="submit" class="btn btn-default">搜索</button>
        </form>
        <!--end 搜索表单-->
    </div>

    <div class="col-xs-6 col-md-2">
        <button type="button" onclick="location.href = '__URL__/expUser?pd=manager&level={$level}'" class="btn btn-info">导出Excel</button>
    </div>
</div>



<!--表格-->
<table class="table table-condensed table-hover table-responsive table-bordered">
    <thead>
        <tr>
            <th>授权编号</th>
            <th>姓名</th>
            <th>手机号</th>
            <th>微信号</th>
            <th>身份证号码</th>
            <th>状态</th>
            <th>级别</th>
            <th>上级名称</th>
            <th>审核人</th>
            <th>推荐人</th>
            <!--<th>{$Think.config.internal_name}级别</th>-->
            <th>授权时间</th>
            <th>用户操作</th>
            <th>业务操作</th>
            <th>权限状态</th>
        </tr>
    </thead>
    <tbody>
    <empty name="mList">
        <tr><td colspan="15">对不起,没有找到经销商! </td></tr>
        <else />
        <!--<tr><td colspan="13"><div class="pull-right">{$page}</div></td></tr>-->
        <volist name="mList" id="m">
            <tr>
                <td>{$m.authnum}</td>
                <td>{$m.name}</td>
                <td>{$m.phone}</td>
                <td>{$m.wechatnum}</td>
                <td>{$m.idennum}</td>
                <td>{$m.audited|toStatus=###}</td>
                <td>{$m.levname}</td>
                <td>{$m.bossname}</td>
                <td>
                    <empty name="m.pname">
                        总部
                        <else />
                        {$m.pname}
                    </empty>
                </td>
                <td>
                    <if condition="$m.recommendID eq 0">
                        总部
                        <else />
                        {$m.recommendID|toAgent=###}
                    </if>
                </td>
                <!--                <td>
                            <eq name="m.internal_level" value="0">无<else />{$config_internal_level[$m['internal_level']]}</eq>
                            <br />
                            <a href="__URL__/internal_edit/id/{$m.id}" class="btn btn-primary btn-default active" role="button">{$Think.config.internal_name}设置</a>
                            </td>-->
                <td>{$m.time|date="Y-m-d H:i",###}</td>
                <td>
                    <button type="button" class="btn btn-primary" onclick="change_dis_div('{$m.id}', '{$m.level}', '{$m.name}', 'up')">升级</button>
                    <!--<input class="btn btn-primary " value="升级" onClick="upgrade({$m.id}, {$m.level}, {$Think.session.did}, {$m.audited})" type="button"/>-->

                    <button type="button" class="btn btn-primary" onclick="location.href = '__URL__/edit/id/{$m.id}'">编辑</button>
                    <button type="button" class="btn btn-primary" onclick="change_dis_div('{$m.id}', '{$m.level}', '{$m.name}', 'down')">降级</button>
                    <!--<input class="btn btn-primary" value="降级" onClick="downgrade({$m.id}, {$m.level}, {$m.audited})" type="button"/>-->
                    <input class="btn btn-danger" value="删除" onClick="sc('{$m.name}', '__URL__/del/id/{$m.id}')" type="button"/>
                    <button type="button" class="btn btn-info" data-toggle="modal" data-target=".xq{$m.id}">详情信息</button>
                </td>
                <td>
                <button type="button" class="btn btn-default" onclick="location.href = '__GROUP__/funds/recharge?uid={$m.id}'">充值</button>
                <button type="button" class="btn btn-default" onclick="location.href = '__GROUP__/integral/recharge?uid={$m.id}'">充入积分</button>
                <!--<button type="button" class="btn btn-default" onclick="location.href = '__GROUP__/order/set_order?uid={$m.id}'">下单</button>-->
            </td>
                <td>
                    <!--                    招募经销商
                                        <if condition="$m.statu eq 0"><a href="#" class="toggle toggle--on"></a><else /><a href="#" class="toggle toggle--off"></a></if>
                                        <input type="hidden" value="{$m.id}" />
                                        <input type="hidden" value="{$m.statu}" />
                                        <input type="hidden" value="1" />
                    
                                        禁用经销商
                                        <if condition="$m.disable eq 1"><a href="#" class="toggle toggle--on"></a><else /><a href="#" class="toggle toggle--off"></a></if>
                                        <input type="hidden" value="{$m.id}" />
                                        <input type="hidden" value="{$m.disable}" />
                                        <input type="hidden" value="2" />-->

                    <div class="checkbox checkbox-slider-md checkbox-slider--c-weight  checkbox-slider-info">
                        <label>
                            <if condition="$m.statu eq 0">
                                <input onclick="return change_dis_statu('{$m.id}','1')" type="checkbox" checked>
                                <else />
                                <input type="checkbox" onclick="return change_dis_statu('{$m.id}','0')">
                            </if>
                            <span>招募经销商</span>
                        </label>
                    </div>

                    <div class="checkbox checkbox-slider-md checkbox-slider--c-weight  checkbox-slider-info">
                        <label>
                            <if condition="$m.disable eq 0">
                                <input onclick="return change_dis_disable('{$m.id}','1')" type="checkbox" checked>
                                <else />
                                <input type="checkbox" onclick="return change_dis_disable('{$m.id}','0')">
                            </if>
                            <span>禁用经销商</span>
                        </label>
                    </div>     
                </td>
            </tr>
        </volist>
        <tr><td colspan="15"><div class="pull-right">{$page}</div></td></tr>
    </empty>
</tbody>
</table>
<!--end 表格-->

<!--经销商详情弹出框-->
<volist name="mList" id="m">
    <div class="modal fade bs-example-modal-lg xq{$m.id}" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">经销商详情</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tr>
                            <td>姓名</td>
                            <td>{$m.name}</td>
                        </tr>
                        <tr>
                            <td>微信头像</td>
                            <td><img src = "{$m.headimgurl}" style="width:70px;height:70px;" /></td>
                        </tr>
                        <tr>
                            <td>微信号</td>
                            <td>{$m.wechatnum}</td>
                        </tr>
                        <tr>
                            <td>电话</td>
                            <td>{$m.phone}</td>
                        </tr>
                        <tr>
                            <td>邮箱</td>
                            <td>{$m.email}</td>
                        </tr>
                        <tr>
                            <td>身份证号</td>
                            <td>{$m.idennum}</td>
                        </tr>
                        <tr>
                            <td>详细地址</td>
                            <td>{$m.address}</td>
                        </tr>
                        <tr>
                            <td>申请时间</td>
                            <td>{$m.time|date="Y-m-d H:i",###}</td>
                        </tr>
                        <if condition="$Think.config.IS_SUBMIT_ID_CARD_IMG eq 1">
                            <tr>
                                <td>身份证图片：</td>
                                <td><img width='100%' src = "{$m.idennumimg}" /></td>
                            </tr>
                            <tr>
                                <td>保证金截图：</td>
                                <td><img width='100%' src = "{$m.liveimg}" /></td>
                            </tr>
                        </if>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</volist>
<!--end 经销商详情弹出框-->



<div class="modal fade bs-example-modal-sm dis_upgrade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h2 class="modal-title" id="dis_upgrade_title">升级</h2>
            </div>

            <!--升级表单-->
            <form class="form-inline" role="form" method="post" action="__URL__/upgrade_post">
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tr class="warning">
                            <td>经销商名</td>
                            <td id="dis_upgrade_name"></td>
                        </tr>
                        <tr class="info">
                            <td>新经销商级别</td>
                            <td>
                                <select id='dis_upgrade_dis_info_select1' name="level" class="form-control">
                                    <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
                                        <if condition="$level gt $key_left_num">
                                            <option class="dis_upgrade_dis_info_select_up" value="{$key_left_num}">{$vo_left_name}</option>
                                            <elseif condition="$level lt $key_left_num" />
                                            <option class="dis_upgrade_dis_info_select_down" value="{$key_left_num}">{$vo_left_name}</option>
                                            <else />
                                        </if>
                                    </foreach>
                                </select>
                            </td>
                        </tr>
                        <tr class="info">
                            <td>上级级别</td>
                            <td>
                                <select id="dis_upgrade_dis_info_select" name="levelone" class="form-control" onchange="return get_dis_info()">
                                    <option value="-1">原上级</option>
                                    <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
                                        <if condition="$level gt $key_left_num">
                                            <option class="dis_upgrade_dis_info_select_up" value="{$key_left_num}">{$vo_left_name}</option>
                                            <elseif condition="$level lt $key_left_num" />
                                            <option class="dis_upgrade_dis_info_select_down" value="{$key_left_num}">{$vo_left_name}</option>
                                            <else />
                                        </if>
                                    </foreach>
                                </select>
                            </td>
                        </tr>
                        <tr class="info">
                            <td>上级经销商</td>
                            <td>
                                <select name="b_id" id="dis_upgrade_dis_info_parent" class="form-control">
                                    <option value="-1">原上级</option>
                                    <option value="0">总部</option>
                                </select>

                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <input id="dis_upgrade_mid" type="hidden" name="mid" value="" />
                    <input id="dis_upgrade_type" type="hidden" name="type" value="" />
                    <input id="dis_upgrade_b_name" type="hidden" name="b_name" value="" />
                    <button type="submit" class="btn btn-success" onclick="" >提交</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                </div>
            </form>
            <!--end 升级表单-->

        </div>
    </div>
</div>

<script>

    //----升级经销商-------

    function change_dis_div(id, level, name, type) {

        if (level == 1 && type == 'up') {
            alert('最高级别无法升级！');
            return;
        }
        if (level == level_num && type == 'down') {
            alert('最低级别无法降级！');
            return;
        }


        //赋值
        var name_str = '<b>' + name + '</b>';
        $("#dis_upgrade_name").html(name_str);
        $("#dis_upgrade_mid").val(id);
        //$("#dis_upgrade_b_name").val(name);

        //弹出框标题
        var dis_upgrade_title = ''
        if (type == 'up') {
            dis_upgrade_title = '升级处理';
            $("#dis_upgrade_type").val('up');
        } else {
            dis_upgrade_title = '降级处理';
            $("#dis_upgrade_type").val('down');
        }

        $("#dis_upgrade_title").html(dis_upgrade_title);

        //级别选择框
        var type_level;
        if (type == 'up') {
            type_level = Number(level) - 1;
            $(".dis_upgrade_dis_info_select_up").show();
            $(".dis_upgrade_dis_info_select_down").hide();
            
            $("#dis_upgrade_dis_info_select1").val(type_level);
            $("#dis_upgrade_dis_info_select").val('-1');
        } else {
            type_level = Number(level) + 1;
            $(".dis_upgrade_dis_info_select_up").hide();
            $(".dis_upgrade_dis_info_select_down").show();
            
            $("#dis_upgrade_dis_info_select1").val(type_level);
            $("#dis_upgrade_dis_info_select").val('-1');
        }

        //上级经销商
        get_dis_info();

        $('.dis_upgrade').modal('show');
    }
    

    function get_select_val(js_id) {
//        var b_id = $("#"+js_id).val();
//        alert($("#"+js_id).val());
//        $("#dis_upgrade_b_id").val(b_id);
    }


    function get_dis_info() {
        level = $("#dis_upgrade_dis_info_select").val();

        $(".dis_upgrade_dis_info_parent_option").hide();

        //如果已经有该级别经销商信息，直接显示
        if ($(".dis_upgrade_dis_info_parent_" + level).length > 0) {
            $(".dis_upgrade_dis_info_parent_" + level).show();
            return;
        }
        else if( level == -1 ){
            $("#dis_upgrade_dis_info_parent").val('-1');
            $("#dis_upgrade_dis_info_parent_0").hide();
            $("#dis_upgrade_dis_info_parent_1").show();
            return;
        }
        else if( level == 0 ){
            $("#dis_upgrade_dis_info_parent").val('0');
            $("#dis_upgrade_dis_info_parent_0").show();
            $("#dis_upgrade_dis_info_parent_1").hide();
            return;
        }
        
        $("#dis_upgrade_dis_info_parent").val('-1');
        $("#dis_upgrade_dis_info_parent_0").show();
        $("#dis_upgrade_dis_info_parent_1").show();

        $.post("__APP__/Radmin/Stock/getAgent", {level: level}, function (data) {
            var text = '';

            if (data != 'none') {
                $.each(data, function (index, array) {
                    text += '<option class="dis_upgrade_dis_info_parent_option dis_upgrade_dis_info_parent_' + level + '" value="' + array["id"] + '">' + array["name"] + '</option>';
                })
            } else {
                text += '<option class="dis_upgrade_dis_info_parent_option dis_upgrade_dis_info_parent_' + level + '" value="">无经销商信息</option>';
            }

            $("#dis_upgrade_dis_info_parent").append(text);
//            $(text).appendTo("#dis_upgrade_dis_info_parent");
        })
    }
    //----end 升级经销商-------


    //--------招募经销商----------

    function change_dis_statu(id,statu) {
        
        var alert_msg = '确认允许该经销商招募经销商吗？';
        if( statu==1 ){
            alert_msg = '确认禁止该经销商招募经销商吗？';
        }
        
        if( !confirm(alert_msg) ){
            return false;
        }
        
        $.ajax({
            async: false,
            type: "POST",
            data: {id: id, statu: statu},
            dataType: "json",
            url: '__URL__/zstatu',
            success: function (ree) {
                
            }
        });
        
        return true;
    }

    function change_dis_disable(id,disable) {
        var alert_msg = '确认允许该经销商使用吗？';
        if( disable==1 ){
            alert_msg = '确认禁止该经销商使用吗？';
        }
        
        if( !confirm(alert_msg) ){
            return false;
        }
        
        $.ajax({
            async: false,
            type: "POST",
            data: {id: id, statu: disable},
            dataType: "json",
            url: '__URL__/disable',
            success: function (ree) {
            }
        });
        
        return true;
    }

    //--------end 招募经销商----------


</script>
