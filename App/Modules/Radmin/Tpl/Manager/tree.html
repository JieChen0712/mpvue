<!DOCTYPE html>
<html lang="en">

  <head>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/Radmin_v3/css/styleone.css">
    <script type="text/javascript">
      var getAgent = '__APP__/Radmin/Stock/getAgent';
      var getParenttree = '__GROUP__/Manager/get_tree';
      var getChild = '__GROUP__/Manager/get_treedirect';
      var search_tree = '__GROUP__/Manager/search_tree';
      var search_id = [];
      var allflag = false;
      var first = true;
      //    var page_p = 1;
      //    var page_c = 1;
      //    var loadchild = '<li class="loadchild"><a class="load_c" onclick="getChildmore(this)">加载更多</a></li>';

      $(function() {
        $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');
        $('#parent_list').on('click', ".parent_li>span>.glyphicon-plus", function(e) {
          var _this = this;
          var slide = $(_this).parent().parent().siblings('li');
          $.each(slide, function(key, value) {
            if($(value).children('ul').is(":visible")) {
              $(value).children('ul').slideUp();
              $(value).children('.loadchild').slideUp();
              $(value).children('ul').siblings('span').attr('title', 'Expand this branch').find(' > i').addClass('glyphicon-plus').removeClass('glyphicon-minus');
            }
          });
          getChilds(_this, e)
        });
        $('#parent_list').on('click', ".parent_li>span>.glyphicon-minus", function(e) {
          var _this = this;
          getChilds(_this, e)
        });
      });
    </script>
    <style>
      /*  .bg{background:url(__PUBLIC__/images/shouquan.jpg);background-size:450px 672px;width:450px;height:672px;margin:0 auto;position:absolute;right:130px;top:45px;}
          .bg h1{font-size:35px;color:#4abcf2;padding-top:193px;margin-left:54px;}
          .bg .test{margin-top:52px;margin-left:55px;min-width:200px;max-width: 325px;}
          .bg p{font-size:18px;line-height:29px;margin: 0 0 0px; }
          .bg hr{margin: 0px 0;}
          #bg{
              -webkit-transform: rotate(45deg);
              -moz-transform: rotate(45deg);
              filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
              overflow: hidden;
              z-index: 9999;
              opacity: 0.1;
              font-size: 30px;
              }*/
        .certificate{
          display: none;
        }
    </style>
  </head>

  <body>
    <section class="layui-container">
      <header class="header">
        <h3>直属经销商树状图</h3>
      </header>
      <div class="tree">
        <div class="select-wrapper">
          <form onsubmit="return false" class="layui-form">
            <div id="level-wrapper">
              <label for="agent-level" clas>选择代理等级：</label>
              <div class="option-item">
                <select name="agent-level" id="agent-level" lay-filter="level">
                  <option value="all">全部</option>
                  <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
                    <option value="{$key_left_num}">{$vo_left_name}</option>
                  </foreach>
                </select>
              </div>
            </div>
            <div id="name-wrapper">
              <label for="agent-name">搜索代理名称：</label>
              <div class="option-item">
                <select name="agent-name" id="agent-name" placeholder="请输入或选择代理名称" lay-filter="agnetname" lay-search></select>
              </div>
            </div>
          </form>
        </div>
        <div class="table-wrapper">
          <div class="row">
            <div class="col-md-12">
              <egt name="level_num" value="1"><span class="level level1"></span>{$level_name.1}</egt>
              <egt name="level_num" value="2"><span class="level level2"></span>{$level_name.2}</egt>
              <egt name="level_num" value="3"><span class="level level3"></span>{$level_name.3}</egt>
              <egt name="level_num" value="4"><span class="level level4"></span>{$level_name.4}</egt>
              <egt name="level_num" value="5"><span class="level level5"></span>{$level_name.5}</egt>
              <egt name="level_num" value="6"><span class="level level6"></span>{$level_name.6}</egt>
              <egt name="level_num" value="7"><span class="level level7"></span>{$level_name.7}</egt>
              <egt name="level_num" value="8"><span class="level level8"></span>{$level_name.8}</egt>
              <egt name="level_num" value="9"><span class="level level9"></span>{$level_name.9}</egt>
              <egt name="level_num" value="10"><span class="level level10"></span>{$level_name.10}</egt>
            </div>
          </div>
          <div class="row">
            <div class="parent-wrapper">
              总部
            </div>
            <div class="col-md-12 tree-list">
              <ul id="parent_list"></ul>
            </div>
            <div class="col-md-4 certificate">
              <div class="embed-responsive embed-responsive-16by9 iframe_div">
                <iframe class='embed-responsive-item' id='iframe_src' src=""></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>
    <script>
      //初始化树状图的根目录
      getTreeRoot();
      getAgentName($('#agent-name'), $('#agent-level').val());

      //监听代理查询的事件
      layui.use('form', function() {
        var form = layui.form;
        form.on('select(level)', function(data) {
          var level = data.value;
          if(level == 'all'&& allflag){
            getTreeRoot();
            allflag = false;
            $('#agent-name').empty();
            $(document).on('input','#agent-name~.layui-form-select>.layui-select-title>.layui-input',function(){getAllName(this)});
            form.render();
            return;
          }
          $(document).off('input','#agent-name~.layui-form-select>.layui-select-title>.layui-input');
          getAgentName($('#agent-name'), level);
        })
        form.on('select(agnetname)', function(data) {
          var id = data.value;
          searchTree(id);
        })
        form.render();
      })

      //获取树状图的根目录
      function getTreeRoot() {
        var page_p = '';
        if(first){
          page_p = 1
          first = !first;
        }else{
          page_p = $('.load_p').data('page')||"";
        }
        if(page_p == ''){
          return;
        }else{
          $.post(getParenttree, {
          page_num: page_p,
          type:'pid'
        }, function(data) {
          if(data.code != 1) {
            return layer.msg(data.msg)
          }
          var temp = [];
          var count = 0;
          if(data.info.list == null || data.info.list == "" || data.info.list == undefined) {
            if($('.tree-list').children('.loadmore').length != 0) {
              $('.tree-list').children('.loadmore').remove()
            }
            return layer.msg('暂无更多数据！')
          }
          $.each(data.info.list, function(key, value) {
            count++;
            if($.inArray(value.id, search_id) != -1){
                return;
              }
            var str = value.count == 0 ? '' : '<i class="glyphicon glyphicon-plus"></i>';
            var html = '<li class="parent_li"><span class="level' + value.level + ' " title="Expand this branch"><input type="hidden" value="' + value.id + '">' +
              str + '</span><a href="javascript:void(0);" data-iframe="__URL__/tree_detail?no_header=1&id='+value.id+'" data-title="'+value.name+'的资料"'+
              'data-tips-text="查看详情"> ' + value.name + ' <i class="fa fa-search"></i></a><b>' + value.count + '</b><ul></ul></li>';
            temp.push(html);
          });
          page_p++;
          if(count == 10 && $('.tree-list').children('.loadmore').length == 0) {
            var loadmore = '<li class="loadmore"><a data-page="' + page_p + '" class="  load_p" onclick="getTreeRoot()">加载更多</a></li>';
            $('.tree-list').append(loadmore);
          }else{
            $('.load_p').data('page',page_p)
          }
          $('#parent_list').append(temp)
        })
        }
        
      }
      //点击加减号加载自己的子类
      function getChilds(_this, e) {
        var page_c = 1;
        var children = $(_this).parent().parent('li.parent_li').find(' > ul > li');
        console.log(children.is(":visible"));
        if(children.is(":visible")) {
          children.hide('fast');
          $(_this).parent().siblings('.loadchild').hide('fast')
          $(_this).parent().attr('title', 'Expand this branch').find(' > i').addClass('glyphicon-plus').removeClass('glyphicon-minus');
        } else {
          children.show('fast')
          var mid = $(_this).parent().children('input').val();
          var tet = $(_this).parent().next('a').next('b').next('ul');
          //判断有没有把下属显示出来
          if(tet.attr('display')=='none' ||tet.html() == "") {
            var temp = [];
            var count = 0;
            $.ajax({
              async: false,
              type: "POST",
              data: {
                mid: mid,
                page_num: page_c,
                type:'pid'
              },
              dataType: "json",
              url: getChild,
              success: function(data) {
                if(data.code != 1) {
                  layer.msg("加载失败！");
                  return;
                } else if(data.info.list == null || data.info.list == undefined || data.info.list == "") {
                  layer.msg("没下级经销商！");
                  return;
                }
                //layer.msg(data);

                $.each(data.info.list, function(key, value) {
                  count++;
                  if($.inArray(value.id, search_id) != -1){
                    return;
                  }
                  var str = value.count > 0 ? '<i class="glyphicon glyphicon-plus"></i>' : '';
                  var html = '<li class="parent_li"><span title="Expand this branch" class="level' + value.level +
                    '"><input type="hidden" value="' + value.id + '">' + str +
                    '</span> <a href="javascript:void(0);" data-iframe="__URL__/tree_detail?no_header=1&id='+value.id+'" data-title="'+value.name+'的资料"'+
                    ' data-tips-text="查看详情">' + value.name + '</a><b>' + value.count + '</b><ul></ul></li>';
                  temp.push(html)
                })
                page_c++;
                if(count == 10 && $(_this).parent().parent().children('.loadchild').length == 0) {
                  $(_this).parent().parent().append('<li class="loadchild"><a class="load_c" data-page="' + page_c + '"  onclick="getChildmore(this)">加载更多</a></li>');
                }
              }
            });
//                        console.log(temp)
            $(_this).parent().next('a').next('b').next('ul').html(temp).slideDown();
          }else{
            $(_this).parent().next('a').next('b').next('ul').html(temp).slideDown();
          }
          children.show('fast');
          $(_this).parent().siblings('.loadchild').slideDown();
          $(_this).parent().attr('title', 'Collapse this branch').find(' > i').addClass('glyphicon-minus').removeClass('glyphicon-plus');
        }
        e.stopPropagation();
      }
      //获取更多的子类，加载更多
      function getChildmore(aim) {
        var page = $(aim).data('page');
        var mid = $(aim).parent().parent().children('span').find('input').val();
        var temp = [];
        var count = 0;
        $.ajax({
          async: false,
          type: "POST",
          data: {
            mid: mid,
            page_num: page,
            type:'pid'
          },
          dataType: "json",
          url: getChild,
          success: function(data) {
            if(data.code != 1) {
              layer.msg("加载失败！");
              return;
            } else if(data.info.list == null || data.info.list == undefined || data.info.list == "") {
              layer.msg("没下级经销商！");
              $(aim).parent().remove();
              return;
            }
            $.each(data.info.list, function(key, value) {
              count++;
              console.log(value.id);
              console.log(search_id);
              if($.inArray(value.id, search_id) != -1){
                return;
              }
              var str = value.count > 0 ? '<i class="glyphicon glyphicon-plus"></i>' : '';
              var html = '<li class="parent_li"><span title="Expand this branch" class="level' + value.level +
                '"><input type="hidden" value="' + value.id + '">' + str +
                '</span> <a href="javascript:void(0);" data-iframe="__URL__/tree_detail?no_header=1&id='+value.id+'" data-title="'+value.name+'的资料"'+
                ' data-tips-text="查看详情">' + value.name + '</a><b>' + value.count + '</b><ul></ul></li>';
              temp.push(html)
            })
            page++;
            console.log($(aim).parent().parent().children('ul'))
            $(aim).data('page', page).parent().parent().children('ul').append(temp);
            console.log($(aim).parent().parent().children('ul'))
            if(count != 10) {
              $(aim).parent().remove();
            }
          }
        });
      }
      //二级联动获取代理姓名
      function getAgentName(aim, level) {
        $.ajax({
          url: getAgent,
          data: {
            level: level
          },
          async: false,
          success: function(data) {
            if(data != 'none') {
              var text = '<option value="">请选择</option>';
              $.each(data, function(index, array) {
                text += '<option class="' + array["id"] + '" value="' + array["id"] + '">' + array["name"] +

                  '</option>';
              })
              aim.html(text);
            } else {
              aim.empty();
              form.render()
              return;
            }
            form.render()
          }
        })
      }

      //搜索经销商
      function searchTree(id) {
        search_id = [];
        $.post(search_tree, {
          mid: id,
          type:'pid'
        }, function(data) {
          if(data.code != 1) {
            console.log(data.msg)
            return;
          } else {
            allflag = true;
            var aim = $('#parent_list');
            var load = '<small class="loadchild" style=""><a class="load_c" data-page="1" onclick="getChildmore(this)">加载更多</a></small>';
            var html = "";
            var alldata = data.Parent_info.reverse();
            var first = true;
            $.each(alldata, function(key, value) {
              search_id.push(value.id);
              var str = value.count > 0 ? '<i class="glyphicon glyphicon-plus"></i>' : '';
              var temp1 = html;
              html = '<li class="parent_li"><span title="Expand this branch" class="level' + value.level +
                '"><input type="hidden" value="' + value.id + '">' + str +
                '</span> <a href="javascript:void(0);" data-iframe="__URL__/tree_detail?no_header=1&id='+value.id+'" data-title="'+value.name+'的资料"'+
                'data-tips-text="查看详情">' + value.name + '</a><b>' + value.count + '</b><ul>' + temp1 + '</ul>'+ (value.count>0&&!first?load:"") +'</li>';
              first = false;
//            console.log((first?'<i class="glyphicon glyphicon-plus"></i>':str))
            });
            $('#parent_list').empty().append(html).siblings('.loadmore').find('a').data('page',1);
          }
        })
      }
      
      //监听输入获取代理名字
      $(document).on('input','#agent-name~.layui-form-select>.layui-select-title>.layui-input',function(){getAllName(this)})
      
      function getAllName(aim){
          var _this = aim;
          var aim = $('#agent-name');
          if($(_this).val().trim().length<1){
            aim.empty();
            form.render();
            $('#agent-name~.layui-form-select>.layui-select-title>.layui-input').attr('placeholder','请输入或选择代理名称');
            return;
          }
          $.ajax({
            type:"post",
            url:"__URL__/agent",
            async:true,
            data:{term:$(_this).val()},
            success:function(data){
              var html = '';
              var count = 50;
              $.each(data, function(key,value) {
                if(count>0){
                  html += '<option value="'+value.id+'">'+value.name+'---'+value.levname+'</option>';
                  count --;
                }else{
                  return;
                }
              });
              aim.empty().append(html);
              form.render('select');
              $('#agent-name~.layui-form-select').addClass("layui-form-selected");
              $('#agent-name~.layui-form-select>.layui-select-title>.layui-input').focus().val($(_this).val()).attr('placeholder','请输入或选择代理名称')
            }
          });
        }
      
      //获取授权证书的iframe
//    function change_iframe_src(id) {
//      var src = 'http://{$YM_DOMAIN}/manager/tree_detail?no_header=1&id=' + id;
//
//      $("#iframe_src").attr('src', src);
//
//      var html = $('.certificate').html();
//      layer.open({
//        type: 1,
//        title: false,
//        closeBtn: 0,
//        area: ['640px', '800px'],
//        shadeClose: true,
//        skin: 'yourclass',
//        content: html
//      });
//    }
    </script>
  </body>

</html>