<!DOCTYPE html>
<html lang="en">
<style type="text/css">
    table tr {
        background: rgb(249, 249, 249) !important;
    }

    .layui-anim-upbit {
        text-align: left !important;
    }

    .layui-input {
        height: 48px;
        box-sizing: border-box;
    }

    .layui-container .content {
        padding-bottom: 0px;
    }

    /*小屏幕样式*/

    @media screen and (max-width: 768px) {
        .table-wrapper .change-wrapper {
            padding-bottom: 20px;
        }
        .table-wrapper .sm-td {
            text-align: left;
            margin-left: 10px;
        }

    }
</style>

<head>

</head>

<body>
    <section class="layui-container">
        <div class="content">
            <header class="header">
                <h3>代理更换上级</h3>
            </header>
            <div class="table-wrapper">
                <form action="" class="layui-form layui-box">
                    <table class="layui-table" lay-skin="row" lay-size="sm">
                        <tr class="change-wrapper">
                            <td class="sm-td">代理：</td>
                            <td class="sm-td">
                                <div id='level_div' class="searchagent">
                                    <select class="form-control" name="level" id="level" lay-filter="level">
                                        <option value="0">请选择代理等级</option>
                                        <egt name="level_num" value="1">
                                            <option value="1">{$level_name.1}</option>
                                        </egt>
                                        <egt name="level_num" value="2">
                                            <option value="2">{$level_name.2}</option>
                                        </egt>
                                        <egt name="level_num" value="3">
                                            <option value="3">{$level_name.3}</option>
                                        </egt>
                                        <egt name="level_num" value="4">
                                            <option value="4">{$level_name.4}</option>
                                        </egt>
                                        <egt name="level_num" value="5">
                                            <option value="5">{$level_name.5}</option>
                                        </egt>
                                        <egt name="level_num" value="6">
                                            <option value="6">{$level_name.6}</option>
                                        </egt>
                                    </select>
                                </div>
                            </td>
                            <td class="sm-td">
                                <div id="mylevel_div">
                                    <select class="form-control mylevel" name="receive_id">
                                        <option value="0">请选择代理</option>
                                    </select>
                                </div>
                            </td>
                            <td class="sm-td">
                                <input class="form-control" type="text" id="daili1" value="" placeholder="请输入代理名字" />
                            </td>
                            <td class="sm-td" style="max-width:85px;">
                                <input onclick="secect_daili('daili1')" class="layui-btn layui-btn-radius layui-btn-normal" value="搜索" type="button" />
                            </td>
                        </tr>
                        <tr class="change-wrapper">
                            <td class="sm-td">新上级代理：</td>
                            <td class="sm-td">
                                <div id='level1_div' class="searchagent">
                                    <select class="form-control" name="level1" id="level1" lay-filter="level1">
                                        <option value="0">请选择代理等级</option>
                                        <option value="-1">总部</option>
                                        <egt name="level_num" value="1">
                                            <option value="1">{$level_name.1}</option>
                                        </egt>
                                        <egt name="level_num" value="2">
                                            <option value="2">{$level_name.2}</option>
                                        </egt>
                                        <egt name="level_num" value="3">
                                            <option value="3">{$level_name.3}</option>
                                        </egt>
                                        <egt name="level_num" value="4">
                                            <option value="4">{$level_name.4}</option>
                                        </egt>
                                        <egt name="level_num" value="5">
                                            <option value="5">{$level_name.5}</option>
                                        </egt>
                                        <egt name="level_num" value="6">
                                            <option value="6">{$level_name.6}</option>
                                        </egt>
                                    </select>
                                </div>
                            </td>
                            <td class="sm-td">
                                <div id="mylevel1_div">
                                    <select class="form-control mylevel1" name="receive_id1">
                                        <option value="0">请选择代理</option>
                                    </select>
                                </div>
                            </td>

                            <td class="sm-td">
                                <input class="form-control" type="text" id="daili2" value="" placeholder="请输入代理名字" />
                            </td>
                            <td class="sm-td" style="max-width:85px;">
                                <input onclick="secect_daili('daili2')" class="layui-btn layui-btn-radius layui-btn-normal" value="搜索" type="button" />
                            </td>
                        </tr>
                        <!--确定按钮-->
                        <tr class="change-wrapper">
                            <td class="sm-td"></td>
                            <td class="layui-anim-upbit sm-td">
                                <input id="btm" class="layui-btn" value="提交" type="button" />
                            </td>
                            <td class="sm-td"></td>
                            <td class="sm-td"></td>
                            <td class="sm-td"></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>


        </div>

    </section>
    <script>
        $(function () {
            form.on('select(level)', function (data) {
                var level = data.value;
                var html = '<option value="0">请选择代理</option>';

                if (level == 0) {
                    $(".mylevel").html(html);
                    return;
                }
                $.post("__APP__/Radmin/Stock/getAgent", {
                    level: level
                }, function (data) {
                    if (data != 'none') {
                        var text = '';
                        $.each(data, function (index, array) {
                            text += '<option class="' + array["id"] + '" value="' +
                                array["id"] + '">' + array["name"] + '</option>';
                        })
                        $(".mylevel").html(text);
                    } else {
                        $(".mylevel").html(html);
                    }
                    form.render()
                })
            })
        })
        $(function () {
            form.on('select(level1)', function (data) {
                var level1 = data.value;

                var html = '<option value="0">请选择代理</option>';
                if (level1 == 0) {
                    $(".mylevel1").html(html);
                    form.render('select');
                    return;
                } else if (level1 == '-1') {
                    html = '<option class="0" value="0">总部</option>';
                    $(".mylevel1").html(html);
                    form.render('select');
                    return;
                }
                $.post("__APP__/Radmin/Stock/getAgent", {
                    level: level1
                }, function (data) {
                    if (data != 'none') {
                        var text = '';
                        $.each(data, function (index, array) {
                            text += '<option class="' + array["id"] + '" value="' +
                                array["id"] + '">' + array["name"] + '</option>';
                        })
                        $(".mylevel1").html(text);
                    } else {
                        $(".mylevel1").html(html);
                    }
                    form.render('select')
                })
            })
        })
        $(function () {
            $("#btm").click(function () {
                var level = $("#level").val();
                var level1 = $("#level1").val();
                if (level != '' && level1 != '') {
                    if (level > level1 || true) {
                        var o_id = $(".mylevel").val();
                        var user_id = $(".mylevel1").val();
                        var o_name = $(".mylevel ." + o_id).html();
                        var user_name = $(".mylevel1 ." + user_id).html();
                        if (o_id == 0 || (user_id == 0 && user_name != '总部')) {
                            layer.msg("请选择代理！");
                            return;
                        }
                        if (o_id != user_id) {
                            layer.confirm("您确定要将“" + o_name + "”转移到“" + user_name + "”旗下吗？",
                                function (index) {
                                    layer.close(index);
                                    $.post("__URL__/setupone", {
                                        o_id: o_id,
                                        user_id: user_id,
                                        o_name: o_name,
                                        user_name: user_name
                                    }, function (data) {
                                        if (data.code == 1) {
                                            layer.msg("转移成功！");
                                            setTimeout(function () {
                                                window.location.reload();
                                            }, 1000);
                                        } else if (data.msg != '') {
                                            layer.msg(data.msg);
                                        } else {
                                            layer.msg("转移失败！");
                                        }
                                    });
                                })
                        } else {
                            layer.msg("相同代理不能转移！");
                        }
                    } else {
                        layer.msg("上级代理级别要大于下级代理");
                    }
                } else {
                    layer.msg("请选择！");
                }
            })
        })
        layui.use('form', function () {
            var form = layui.form;
        })
        form.render()
        //选择代理
        function secect_daili(js_id) {
            var name = $("#" + js_id).val();

            $.post("__GROUP__/manager/get_distributor_info", {
                name: name
            }, function (res) {
                if (res.status == 'succ') {
                    change_select(js_id, res.levenames, res.data)
                } else {
                    layer.msg(res.msg);
                }
                form.render()
            });
        }

        //更改选择栏
        function change_select(js_id, levenames, data) {
            var key, level_sel_id_div, mylevel_sel_id_div, input_class;


            if (js_id == 'daili1') {
                key = '';
                level_sel_id_div = 'level_div';
                mylevel_sel_id_div = 'mylevel_div';
                input_class = 'mylevel';
            } else if (js_id == 'daili2') {
                key = '1';
                level_sel_id_div = 'level1_div';
                mylevel_sel_id_div = 'mylevel1_div';
                input_class = 'mylevel1';
            } else {
                return false;
            }

            var text1 = '';
            $.each(levenames, function (index, array) {
                text1 += '<option value=\'' + array["level"] + '\'>' + array["levname"] + '</option>';
            })
            text1 = '<select id="level' + key + '" class="form-control " name="level' + key + '">' + text1 +
                "</select>";

            $("#" + level_sel_id_div).html(text1);


            var text2 = '';
            $.each(data, function (index, array1) {
                text2 += '<option  class=' + array1["id"] + ' value="' + array1["id"] + '">' + array1["name"] +
                    '</option>';
            })
            text2 = '<select class="form-control ' + input_class + '" name="receive_id' + key + '">' + text2 +
                "</select>";

            $("#" + mylevel_sel_id_div).html(text2);
        }
    </script>
</body>

</html>