<layout name="Public/public" />


<head>

    <link href="__PUBLIC__/css/index.css" rel="stylesheet">
    <link href="__PUBLIC__/Radmin_v2/css/invite.css" rel="stylesheet">
    <script type="text/javascript" src="__PUBLIC__/Admin/js/agentcode.js"></script>

    <script type="text/javascript" src='__PUBLIC__/js/jquery.js'></script>
    <script type="text/javascript" src='__PUBLIC__/js/index.js'></script>
    <script type="text/javascript" src="__PUBLIC__/js/WdatePicker.js"></script>
    <script src="__PUBLIC__/Radmin_v2/js/qrcode.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="__PUBLIC__/Radmin_v2/js/clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="__PUBLIC__/Radmin_v2/js/Jie.js" type="text/javascript" charset="utf-8"></script>
    <script src="__PUBLIC__/Radmin_v2/js/qronline.js" type="text/javascript" charset="utf-8"></script>
    
    <script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Admin/js/jquery-ui.js" ></script>
    <link href="__PUBLIC__/Admin/css/jquery-ui.css" type="text/css" rel="stylesheet" />


    <script type="text/javascript">
        var qrurl = '__GROUP__/invite/generate_link_ajax';
        var register = {
            level: '',
            wechatnum: '',
            phone: '',
            idennum: '',
            email: '',
            deadline: '',
            name: '',
            pid : '',
            sear_pid : ''
        }
    </script>
</head>

<h1 class="page-header">
    特邀注册
</h1>

<div class="thumbnail">
    <img id="qrimg" data-src="holder.js/300x300" src="" alt="">

    <div class="caption">
        <form method="post" id="create_qr">
            <table class="table table-striped">
                <tbody>
                    <tr>
                        <td><span class="require">*</span>级别</td>
                        <td>
                            <label class="sr-only" for="level">级别</label>
                            <select name="type" id="level"  class="form-control" required="required">
                                <option value="">选择级别</option>
                                <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
                                    <option value="{$key_left_num}">{$vo_left_name}</option>
                                </foreach>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="require">*</span>微信号</td>
                        <td>
                            <label class="sr-only" for="wechatnum">微信号</label>
                            <input type="text" class="form-control" id="wechatnum" placeholder="微信号" required="required">
                        </td>
                    </tr>
                    <tr>
                        <td><span class="require">*</span>手机号</td>
                        <td>
                            <label class="sr-only" for="phone">手机号</label>
                            <input type="tel" class="form-control" id="phone" placeholder="手机号" required="required" pattern="^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$">
                        </td>
                    </tr>
                    <tr>
                        <td>身份证</td>
                        <td>
                            <label class="sr-only" for="idennum">身份证</label>
                            <input type="text" class="form-control" id="idennum" placeholder="身份证" pattern="(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)">
                        </td>
                    </tr>
                    <tr>
                        <td>姓名</td>
                        <td>
                            <label class="sr-only" for="name">姓名</label>
                            <input type="text" class="form-control" id="name" placeholder="姓名">
                            <span class="require explains">注：姓名为空时，默认为微信昵称！</span>
                        </td>
                    </tr>
                    <tr>
                        <td>邮箱</td>
                        <td>
                            <label class="sr-only" for="email">邮箱</label>
                            <input type="email" class="form-control" id="email" placeholder="邮箱">
                        </td>
                    </tr>

                    <tr id="choose_dis">
                        <td>经销商上级：</td>
                        <td>
                            <select name="level1" id="level1" class="form-control" >
                                <option value="0">请选择经销商上级等级</option>
                                <option value="-1">总部</option>
                                <foreach name="Think.config.LEVEL_NAME" key="key_left_num" item="vo_left_name">
                                    <option value="{$key_left_num}">{$vo_left_name}</option>
                                </foreach>
                            </select>
                            <select id="pid" name="pid" class="mylevel1 form-control">
                                <option value="0">请选择经销商</option>
                            </select>

                            <button type="button" id="search_dis_button" class="btn btn-info">搜索经销商</button>
                        </td>
                    </tr>

                    <tr id="search_dis">
                        <td>经销商上级：</td>
                        <td>
                            <input type="text" id="agent" class="form-control" placeholder="请输入经销商姓名" onmouseup="this.select();" maxlength="80" style="width:300px;" />
                            <input type="hidden" id='sear_pid' name="sear_pid">
                        </td>
                    </tr>

                    <tr>
                        <td>截止时间</td>
                        <td>
                            <label class="sr-only" for="email">截止时间</label>
                            <input type="text" name="select-time" id="deadline" placeholder="截止时间" onclick="WdatePicker()">
                            <span class="explains require">注：截止时间为空时，链接永久生效！</span>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button type="submit" class="btn btn-primary">重新生成特邀链接</button>
                            <span class="explains require">注：更改资料后需重新生成二维码！</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>

        <h3>将此链接发送给特邀注册的经销商，系统将为TA自动注册</h3>
        <p>
            <!--温馨提示：如果iPhone长按识别二维码的页面上传图片时出现错误，请发送此链接-->
            <code id="qrlinks">
            </code>
        </p>
    </div>
</div>


<script type="text/javascript">
    $().ready(function () {
        $("#create_qr").submit(function () {
            
            register.level = $("#level option:selected").val();
            register.wechatnum = $("#wechatnum").val();
            register.phone = $("#phone").val();
            register.idennum = $("#idennum").val();
            register.email = $("#email").val();
            register.name = $("#name").val();
            register.pid = $("#pid").val();
            register.sear_pid = $("#sear_pid").val();
            
            if (!($("#deadline").val() == '' || $("#deadline").val() == null || $("#deadline").val() == undefined)) {
                register.deadline = subStrs($("#deadline").val());
            }
            $.post(qrurl,
                    register,
                    function (data) {
                        if (data.code != 1) {
                            alert(data.msg);
                        } else {
                            images = QRCode.generatePNG(data.info.toString(), {
                                ecclevel: "M",
                                format: "html",
                                fillcolor: "#FFFFFF",
                                textcolor: "#373737",
                                margin: 4,
                                modulesize: 8
                            });
                            $("#qrimg").attr("src", images);
                            $("#qrlinks").text(data.info);
                            var btnstr = '<button data-clipboard-action="copy" data-clipboard-text="' + data.info.trim() + '" class="btn btn-info" id="copyurl">复制链接</button>';
                            $("#qrlinks").append(btnstr);
                        }

                    });
            return false;
        });
    });


    $(function () {
        $("#search_dis").hide();

        $("#search_dis_button").click(function () {
            $("#search_dis").show();
            $("#choose_dis").hide();
        });



        $("#level1").change(function () {
            var level1 = $(this).val();
            var html = '<option value="0">请选择经销商</option>';
            if (level1 == 0) {
                $(".mylevel1").html(html);
                return;
            } else if (level1 == '-1') {
                html = '<option value="0">总部</option>';
                $(".mylevel1").html(html);
                return;
            }
            $.post("__APP__/Radmin/Stock/getAgent", {level: level1}, function (data) {
                if (data != 'none') {
                    var text = '';
                    $.each(data, function (index, array) {
                        text += '<option class="' + array["id"] + '" value="' + array["id"] + '">' + array["name"] + '</option>';
                    })
                    $(".mylevel1").html(text);
                } else {
                    $(".mylevel1").html(html);
                }
            })
        })


        

    })



    $("#agent").autocomplete({
        minLength: 1,
        autoFocus: true,
        source: function (request, response) {
            $.ajax({
                url: "__URL__/agent",
                dataType: "json",
                data: {
                    term: request.term,
                },
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
//						data: item,
                            label: item.name + '---' + item.levname,
// 						value :item.agent_name,
                            ID: item.id,
//						province: item.agent_province,
//						city: item.agent_city,
                        }
                    }));
                }
            });
        },
        select: function (event, ui) {
//		$('#order_address').val(ui.item.address+item.agent_city);
            $('#sear_pid').val(ui.item.ID);
        }
    });


</script>