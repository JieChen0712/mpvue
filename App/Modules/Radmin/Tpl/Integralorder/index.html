<!DOCTYPE html>
<html lang="en">

<head>
    <script type="text/javascript">
      var searchUrl = "{:U(GROUP_NAME . '/Order/search',array('id' => 8,'keyword' => '9'))}";
      form.render();
      layui.use('laydate', function() {
        var laydate = layui.laydate;
        laydate.render({
          elem: '#start_time'
        });
        laydate.render({
          elem: '#end_time'
        });
      })

   </script>
    <script src="__PUBLIC__/Radmin_v3/js/audit.js"></script>
    <script type="text/javascript">
        var auditUrl = '{:U(GROUP_NAME . "/Integralorder/finish_order_audit")}/';
        //        var auditUrl = '{:U(GROUP_NAME . "/funds/apply_refund_pass")}/';
        //        var delUrl = '{:U(GROUP_NAME . "/Order/delorder")}/';

    </script>
</head>

<body>
<section class="layui-container">
    <div class="content">
        <header class="header">
            <eq name="status" value="">
                <h3>全部订单</h3>
            </eq>
            <eq name="status" value="1">
                <h3>待付款订单</h3>
            </eq>
            <eq name="status" value="2">
                <h3>配送中订单</h3>
            </eq>
            <eq name="status" value="3">
                <h3>已收货订单</h3>
            </eq>
            <eq name="status" value="6">
                <h3>待发货订单</h3>
            </eq>
            <!--<a href="__URL__/expUser?pd=order&con_url={$con_url}" class="layui-btn layui-btn-radius layui-btn-normal">导出Excel</a>-->
            <a href="__URL__/expUser?pd=integralorder&con_url={$con_url}" class="layui-btn layui-btn-radius layui-btn-normal">导出Excel</a>
            <eq name="status" value="6">
                <input type="button" class="layui-btn layui-btn-radius layui-btn-normal" id="audit" data-status="{$status}" value="发货审核"/>
            </eq>
            <if condition="($status eq 6) OR ($status eq 2)">
                <div class="layui-upload" >
                    <!--<form class="form-inline" method="post" action="__URL__/impordernumber?type=order" enctype="multipart/form-data">-->
                    <button type="button" class="layui-btn" id="test1"><i class="layui-icon"></i>导入快递单号</button>
                    <!--</form>-->
                </div>
            </if>
        </header>
        <form class="layui-form form layui-row form-search" action="__SELF__" method="get" onsubmit="return false">
            <div class="layui-form-item form-item">
                <label class="layui-form-label" for="start_time">开始时间</label>
                <div class="time-wrapper">
                  <input type="text" class="layui-input blue" name="start_time" id="start_time" readonly="readonly" placeholder="开始时间" autocomplete="on">
                  <i class="fa fa-angle-down"></i>
                </div>
            </div>
            <div class="layui-form-item form-item">
                <label class="layui-form-label" for="end_time">结束时间</label>
                <div class="time-wrapper">
                  <input type="text" class="layui-input blue" name="end_time" id="end_time" readonly="readonly" placeholder="结束时间" autocomplete="on">
                  <i class="fa fa-angle-down"></i>
                </div>
            </div>

            <div class="layui-form-item form-item">
                <label class="layui-form-label" for="order_num">订单号</label>
                <div class="input-wrapper">
                    <input type="text" autocomplete="on" class="layui-input" id="order_num" name="order_num" placeholder="请输入订单号">
                </div>
            </div>
            <div class="layui-form-item form-item">
                <label class="layui-form-label" for="name">代理</label>
                <div class="input-wrapper">
                    <input type="text" autocomplete="on" class="layui-input" id="name" name="name" placeholder="接单代理/订货代理">
                </div>
            </div>

          <div class="layui-form-item form-item">
                <label class="layui-form-label" for="p_id">产品</label>
                <div class="select-wrapper">
                    <select name="p_id" id="p_id" lay-verify="required">
                        <option value="">选择产品</option>
                        <volist name="dis_templet_List" id="m">
                            <option value="{$m.id}">{$m.name}</option>
                        </volist>
                    </select>
                </div>
            </div>
            <div class="layui-form-item form-item">
                <label class="layui-form-label" for="status">订单状态</label>
                <div class="select-wrapper">
                    <select name="status" id="status" lay-verify="required">
                        <option value="">选择订单状态</option>
                        <option value="1">待付款</option>
                        <!--<option value="6">待付款</option>-->
                        <option value="2">配送中</option>
                        <option value="3">已收货</option>
                    </select>
                </div>
            </div>
            <div class="search-btn">
                <!--<input type="hidden" name="status" value="{$status}"/>-->
                <button type="submit" class="layui-btn layui-btn-radius">搜索</button>
            </div>
        </form>
        <div class="table-wrapper">
            <table class="layui-table" lay-skin="row" lay-size="sm">
                <thead>
                <tr>
                    <eq name="status" value="6">
                        <th>
                            <input type="checkbox" id="checkAll"/>
                        </th>
                    </eq>
                    <th>订单号</th>
                    <th>订货经销商</th>
                    <!--<th>接单经销商</th>-->
                    <th>级别</th>
                    <th>产品名称</th>
                    <th>数量</th>
                    <th>单价</th>
                    <th>总价</th>
                    <th>收货人姓名</th>
                    <th>收货人电话</th>
                    <th>收货地址</th>
                    <th>快递单号</th>
                    <th>备注</th>
                    <th>申请时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <empty name="applyList">
                    <tr style="position: relative;">
                        <td style="position: absolute;width: 97%;border-top: solid 1px #e6e6e6;">对不起,没有找到数据!</td>
                    </tr>
                    <else />
                    <volist name="applyList" id="m">
                        <tr>
                            <eq name="status" value="6">
                                <td class="checkItem">
                                    <input type="checkbox" name="mid" value="{$m.order_num}" />
                                </td>
                            </eq>
                            <td>{$m.order_num}</td>
                            <td>{$m.name}</td>
                            <!--<td>{$m.o_name}</td>-->
                            <td>{$m.levname}</td>
                            <td>
                                <volist name="m['row']" id="vv">
                                    {$vv.p_name}x{$vv.num}<br>
                                </volist>
                            </td>
                            <td>
                                {$m.total_num}
                            </td>
                            <td>
                                <volist name="m['row']" id="vv">
                                    {$vv.integral}<br>
                                </volist>
                            </td>
                            <td>{$m.total_integral}</td>
                            <td>{$m.s_name}</td>
                            <td>{$m.s_phone}</td>
                            <td>{$m.s_addre}</td>
                            <td>
                                <div class="kd{$m.id}" style="display:inline">
                                    <div id='shipper_name{$m.id}'>{$m.shipper_name}</div>
                                    <div id="change_order_info_{$m.id}">
                                        <if condition="$m.ordernumber eq ''">
                                            未填写
                                            <else />
                                            {$m.ordernumber}
                                        </if>
                                    </div>

                                    <button type="button"  data-modal="__URL__/index_kd?order_num={$m.order_num}"  class="layui-btn layui-btn-radius layui-btn-normal">更新</button>
                                </div>
                                <!--<select id="shipper{$m.id}" class="form-control change_order_dis change_order_{$m.id}">-->
                                    <!--<option value="">选择快递公司</option>-->
                                    <!--<?php foreach( $shipper as $k => $v ):?>-->
                                    <!--<option class="shipper_detail_name{$k}" value="{$k}">{$k}-{$v}</option>-->
                                    <!--<?php endforeach;?>-->
                                <!--</select>-->

                                <!--<input type="text" placeholder="请填写快递单号" class="form-control change_order_dis change_order_{$m.id}" id="ordernumber_{$m.id}" >-->
                                <!--<input type="submit" onclick="onumber('{$m.id}', '{$m.order_num}');" class="btn btn-success change_order_dis change_order_{$m.id}" value="提交" />-->
                                <!--<input type="button" onclick="cancle('{$m.id}');" class="btn btn-success change_order_dis change_order_{$m.id}" style="background-color: #5bc0de" value="取消" />-->


                                <if condition="($m.shipper neq null) AND ($m.ordernumber neq null) ">
                                    <foreach name="m['ordernumber_arr']" item="a_ordernumber">
                                        <!--<a target="__bank" href="http://api.weisika.net/kd100/index/jump?ShipperCode={$m.shipper}&LogisticCode={$a_ordernumber}&callbackurl=http://{$Think.config.YM_DOMAIN}__GROUP__/order/index" -->
                                           <!--class="layui-btn layui-btn-radius wlxx{$m.id}">物流信息</a>-->
                                        <a target="__bank" href="http://api.weisika.net/kd100/index/jump?ShipperCode={$m.shipper}&LogisticCode={$a_ordernumber}" class="layui-btn layui-btn-radius wlxx{$m.id}">物流信息</a>
                                    </foreach>
                                </if>
                            </td>
                            <td>{$m.notes}</td>
                            <td>{$m.time|date="Y-m-d H:i",###}</td>
                            <td>
                                <if condition="$m.status eq 1">
                                    <p class="layui-bg-red">待付积分</p>
                                    <elseif condition="$m.status eq 2"/>
                                    <p class="layui-bg-orange">配送中</p>
                                    <elseif condition="$m.status eq 6"/>
                                    <p class="layui-bg-green">待发货</p>
                                    <else/>
                                    <p class="layui-bg-blue">已收货</p>
                                </if>
                                <!--<button type="button" class="layui-btn layui-btn-radius layui-btn-normal" data-toggle="modal" data-target=".bs-example-modal-lg-{$m.id}">详情</button>-->
                                <button type="button" data-iframe="__URL__/index_iframe?id={$m.id}" data-title='详情' class="layui-btn layui-btn-radius layui-btn-normal">详情</button>
                                <!--<button type="button" class="btn btn-danger" onclick="sc('{$m.order_num}', '__URL__/delOrder/id/{$m.order_num}')">删除</button>-->
                            </td>
                        </tr>
                    </volist>
                    <include file="Public/page" />
                    <!-- <div id="page"></div> -->
                    <!--<tr><td colspan="14"><div class="pull-right">{$page}</div></td></tr>-->
                </empty>
                </tbody>
            </table>


            <volist name="applyList" id="m">
                <!--订单详情-->
                <div class="modal fade bs-example-modal-lg-{$m.id}" id="dialog" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">订单详情</h4>
                            </div>

                            <div class="modal-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <td>订单号</td>
                                        <td>{$m.order_num}</td>
                                    </tr>
                                    <tr>
                                        <td>订货经销商</td>
                                        <td>{$m.name}</td>
                                    </tr>
                                    <tr>
                                        <td>订货经销商电话</td>
                                        <td>{$m.phone}</td>
                                    </tr>
                                    <tr>
                                        <td>接单经销商</td>
                                        <td>{$m.o_name}</td>
                                    </tr>
                                    <!--                                <tr>
                                                                        <td>接单经销商电话</td>
                                                                        <td>{$m.bossphone}</td>
                                                                    </tr>-->
                                    <tr>
                                        <td>订货产品</td>
                                        <td><volist name="m['row']" id="vv">
                                            {$vv.p_name}x{$vv.num}<br>
                                        </volist></td>
                                    </tr>
                                    <!-- <tr>
                                        <td class="tdbo">订货数量</td>
                                        <td><volist name="m['row']" id="vv">
                                          {$vv.num}<br>
                                        </volist></td>
                                    </tr>
                                    <tr>
                                        <td class="tdbo">订货单价</td>
                                        <td><volist name="m['row']" id="vv">
                                          {$vv.price}<br>
                                        </volist></td>
                                    </tr>
                                    <tr>
                                        <td class="tdbo">订货总价</td>
                                        <td>{$m.sum}.00</td>
                                    </tr> -->
                                    <tr>
                                        <td>收货人名称</td>
                                        <td>{$m.s_name}</td>
                                    </tr>
                                    <tr>
                                        <td>收货人电话</td>
                                        <td>{$m.s_phone}</td>
                                    </tr>
                                    <tr>
                                        <td>收货地址</td>
                                        <td>{$m.s_addre}</td>
                                    </tr>
                                    <tr>
                                        <td>订单时间</td>
                                        <td>{$m.time|date="Y-m-d H:i",###}</td>
                                    </tr>
                                    <tr>
                                        <td>订单备注：</td>
                                        <td>{$m.notes}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end 订单详情-->


                <!--<div class="modal fade bs-example-modal-sm change_order_{$m.id}" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <form class="form-inline" method="post" action="__URL__/ordernb">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">更新快递单号/物流号</h4>
                            </div>

                            <div class="modal-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <td>订单号</td>
                                        <td>{$m.order_num}</td>
                                    </tr>
                                    <tr>
                                        <td>经销商名字</td>
                                        <td>{$m.name}</td>
                                    </tr>
                                    <tr>
                                        <td>产品名称</td>
                                        <td>
                                            <volist name="m['row']" id="vv">
                                            {$vv.pr_name}x{$vv.num}<br>
                                            </volist>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>快递单号/物流号</td>
                                        <td>
                                            <label class="sr-only" for="ordernumber_{$m.id}">快递单号/物流号</label>
                                            <input type="text" class="" id="ordernumber_{$m.id}" name="ordernumber" >

                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <input type="hidden" name="order_num" value="{$m.order_num}" >
                                <input type="submit" class="btn btn-success" value="提交" />
                                <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                            </div>

                        </div>
                    </div>
                    </from>
                </div>-->


            </volist>
        </div>

    </div>

</section>

<script>
  $(".change_order_dis").hide();

  function change_order(id) {
    $('.kd' + id).hide();
    $('.wlxx' + id).hide();
    $(".change_order_" + id).toggle();
  }
  
  function onumber(id, order_num) {
    var ordernumber = $('#ordernumber_' + id).val();
    var shipper = $('#shipper' + id).val();
    var shipper_detail_name = $(".shipper_detail_name" + shipper).html();
  
    $.post("__URL__/ordernb", {
      id: id,
      order_num: order_num,
      ordernumber: ordernumber,
      shipper: shipper
    }, function(data) {
      if(data) {
        layer.msg('填写成功！');
        change_order(id);
        $("#change_order_info_" + id).html(ordernumber);
        $("#shipper_name" + id).html(shipper_detail_name);
        $('.kd' + id).show();
        $('.wlxx' + id).show();
        window.location.reload();
      } else {
        layer.msg('填写失败！原因没做出改变！');
      }
    });
  }
  
  function cancle(id) {
    change_order(id);
    $('.kd' + id).show();
    $('.wlxx' + id).show();
  }
</script>
<script type="text/javascript">
    //            日期范围
    layui.use(['laydate', 'upload'], function() {
        var $ = layui.jquery
            ,upload = layui.upload
            ,laydate = layui.laydate;
        laydate.render({
            elem: '#timeChoose',
            range: '-',
            format: 'yyyyMMdd',
        });
        //          文件上传
        var uploadInst = upload.render({
            elem: '#test1',
            url: '__URL__/impordernumber_integralorder_ajax',
            accept: 'file', //普通文件
            exts:'xls|xlsx',
            auto:true,
            done: function(res) {
                layer.closeAll('loading'); //关闭loading

                if( res.code == 1 ){
                    layer.msg(res.msg);
                    location.reload();
                }
                else if( res.msg != null && res.msg != '' ){
                    layer.msg(res.msg);
                }
                else{
                    layer.msg('未定义错误，可能是系统繁忙，请重试！');
                }
            },
            error: function(index, upload){
                layer.closeAll('loading'); //关闭loading
                //当上传失败时，你可以生成一个“重新上传”的按钮，点击该按钮时，执行 upload() 方法即可实现重新上传
                layer.msg('无法调用文件上传！');
            }
        });
    })
</script>
</body>

</html>